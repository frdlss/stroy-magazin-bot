import asyncio
import sqlite3
import math
from typing import List, Tuple, Optional, Dict
from datetime import datetime
import logging

from aiogram import Bot, Dispatcher, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardRemove
from aiogram.filters import Command, CommandStart
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import WebAppInfo

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
API_TOKEN = ""
ADMIN_IDS = []  # ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=API_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

logging.basicConfig(
    level=logging.INFO,
    format="%(levelname)s - %(message)s",
)
logger = logging.getLogger(__name__)

class SimpleCalculationState(StatesGroup):
    entering_length = State()
    entering_width = State() 
    entering_height = State()
    showing_result = State()

# –°–æ—Å—Ç–æ—è–Ω–∏—è FSM
class AdminState(StatesGroup):
    adding_product_name = State()
    adding_product_price = State()
    adding_product_quantity = State()
    adding_product_category = State()
    adding_product_unit = State()
    adding_product_description = State()
    editing_product_name = State()
    editing_product_price = State()
    editing_product_quantity = State()
    editing_product_category = State()
    editing_product_unit = State()
    editing_product_description = State()
    adding_staff = State()
    removing_staff = State()

class CalculationState(StatesGroup):
    # –í—ã–±–æ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    choosing_material = State()
    entering_dimensions = State()
    # –†–∞–∑–º–µ—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞ - –∫–∏—Ä–ø–∏—á
    entering_brick_length = State()
    entering_brick_width = State()
    entering_brick_height = State()
    entering_brick_weight = State()
    entering_brick_pulsatility = State()
    
    # –†–∞–∑–º–µ—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞ - –±–ª–æ–∫–∏
    entering_block_length = State()
    entering_block_width = State()
    entering_block_height = State()
    entering_block_density = State()
    entering_block_weight = State()

    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–æ–µ–Ω–∏—è
    entering_perimeter = State()
    entering_wall_height = State()
    choosing_wall_thickness = State()
    choosing_mortar_thickness = State()
    
    # –§—Ä–æ–Ω—Ç–æ–Ω—ã
    asking_gables = State()
    entering_gables_count = State()
    entering_gable_width = State()
    entering_gable_height = State()
    
    # –û–∫–Ω–∞ –∏ –¥–≤–µ—Ä–∏
    asking_openings = State()
    entering_windows_count = State()
    entering_window_width = State()
    entering_window_height = State()
    asking_more_windows = State()
    entering_doors_count = State()
    entering_door_width = State()
    entering_door_height = State()
    asking_more_doors = State()
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    asking_mesh = State()
    choosing_mesh_frequency = State()
    asking_price = State()
    entering_price = State()
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞
    confirming_calculation = State()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def init_db():
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    
    # –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS products (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        price REAL NOT NULL,
        quantity INTEGER NOT NULL,
        category TEXT NOT NULL,
        unit TEXT DEFAULT '—à—Ç.',
        description TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
    ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS staff (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL UNIQUE,
        username TEXT,
        full_name TEXT,
        added_by INTEGER,
        added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
    ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ –∞—É–¥–∏—Ç–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π)
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS audit_log (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        username TEXT,
        action TEXT NOT NULL,
        details TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
    ''')
    
    # –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    cursor.execute("SELECT COUNT(*) FROM products")
    if cursor.fetchone()[0] == 0:
        sample_products = [
            ('–ö–µ—Ä–∞–º–∑–∏—Ç —Ñ—Ä–∞–∫—Ü–∏—è 10-20 –º–º', 1500, 100, '–∫–µ—Ä–∞–º–∑–∏—Ç', '–º¬≥', '–í—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–µ—Ä–∞–º–∑–∏—Ç –¥–ª—è —É—Ç–µ–ø–ª–µ–Ω–∏—è –∏ –¥—Ä–µ–Ω–∞–∂–∞'),
            ('–ö–∏—Ä–ø–∏—á –∫—Ä–∞—Å–Ω—ã–π –ø–æ–ª–Ω–æ—Ç–µ–ª—ã–π –ú150', 25, 5000, '–∫–∏—Ä–ø–∏—á', '—à—Ç.', '–ü—Ä–æ—á–Ω—ã–π —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –∫–∏—Ä–ø–∏—á –¥–ª—è –Ω–µ—Å—É—â–∏—Ö —Å—Ç–µ–Ω'),
            ('–ö–∏—Ä–ø–∏—á –æ–±–ª–∏—Ü–æ–≤–æ—á–Ω—ã–π –∂—ë–ª—Ç—ã–π', 35, 3000, '–∫–∏—Ä–ø–∏—á', '—à—Ç.', '–î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –∫–∏—Ä–ø–∏—á –¥–ª—è —Ñ–∞—Å–∞–¥–Ω—ã—Ö —Ä–∞–±–æ—Ç'),
            ('–ì–∞–∑–æ–±–µ—Ç–æ–Ω–Ω—ã–π –±–ª–æ–∫ D500 600x300x200', 4500, 200, '–±–ª–æ–∫–∏', '–º¬≥', '–¢–µ–ø–ª—ã–π –∏ –ª–µ–≥–∫–∏–π –≥–∞–∑–æ–±–µ—Ç–æ–Ω–Ω—ã–π –±–ª–æ–∫'),
            ('–ü–µ–Ω–æ–±–ª–æ–∫ 600x300x200 –º–º', 4200, 150, '–±–ª–æ–∫–∏', '–º¬≥', '–ü–µ–Ω–æ–±–µ—Ç–æ–Ω–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –ø–µ—Ä–µ–≥–æ—Ä–æ–¥–æ–∫'),
            ('–ü–µ—Ä—Ñ–æ—Ä–∞—Ç–æ—Ä Bosch GBH 2-26 DRE', 12000, 15, '–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', '—à—Ç.', '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä—Ñ–æ—Ä–∞—Ç–æ—Ä —Å SDS-plus'),
            ('–ü–µ—Å–æ–∫ –∫–∞—Ä—å–µ—Ä–Ω—ã–π –º—ã—Ç—ã–π', 800, 1000, '–ø–µ—Å–æ–∫', '–º¬≥', '–û—á–∏—â–µ–Ω–Ω—ã–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –ø–µ—Å–æ–∫ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç'),
            ('–¶–µ–º–µ–Ω—Ç –ú500 –î0 50–∫–≥', 450, 200, '—Ü–µ–º–µ–Ω—Ç', '–º–µ—à–æ–∫', '–í—ã—Å–æ–∫–æ–º–∞—Ä–æ—á–Ω—ã–π —Ü–µ–º–µ–Ω—Ç –±–µ–∑ –¥–æ–±–∞–≤–æ–∫'),
            ('–û–ü–ì–° –°-6', 1200, 800, '–æ–ø–≥—Å', '–º¬≥', '–û–±–æ–≥–∞—â–µ–Ω–Ω–∞—è –ø–µ—Å—á–∞–Ω–æ-–≥—Ä–∞–≤–∏–π–Ω–∞—è —Å–º–µ—Å—å')
        ]
        cursor.executemany(
            "INSERT INTO products (name, price, quantity, category, unit, description) VALUES (?, ?, ?, ?, ?, ?)",
            sample_products
        )
    
    conn.commit()
    conn.close()

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
def log_audit(user_id: int, username: str, action: str, details: str = None):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute(
        "INSERT INTO audit_log (user_id, username, action, details) VALUES (?, ?, ?, ?)",
        (user_id, username, action, details)
    )
    conn.commit()
    conn.close()

def get_audit_log(limit: int = 20):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute(
        "SELECT * FROM audit_log ORDER BY created_at DESC LIMIT ?",
        (limit,)
    )
    log = cursor.fetchall()
    conn.close()
    return log

def get_products_by_category(category: str = None, page: int = 1, per_page: int = 5):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    
    if category:
        cursor.execute(
            "SELECT COUNT(*) FROM products WHERE category = ?",
            (category,)
        )
        total = cursor.fetchone()[0]
        
        cursor.execute(
            "SELECT * FROM products WHERE category = ? ORDER BY name LIMIT ? OFFSET ?",
            (category, per_page, (page - 1) * per_page)
        )
    else:
        cursor.execute("SELECT COUNT(*) FROM products")
        total = cursor.fetchone()[0]
        
        cursor.execute(
            "SELECT * FROM products ORDER BY category, name LIMIT ? OFFSET ?",
            (per_page, (page - 1) * per_page)
        )
    
    products = cursor.fetchall()
    conn.close()
    
    return products, total

def get_product_categories():
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute("SELECT DISTINCT category FROM products ORDER BY category")
    categories = [row[0] for row in cursor.fetchall()]
    conn.close()
    return categories

def get_all_products():
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM products ORDER BY category, name")
    products = cursor.fetchall()
    conn.close()
    return products

def get_product_by_id(product_id: int):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM products WHERE id = ?", (product_id,))
    product = cursor.fetchone()
    conn.close()
    return product

def add_product(name: str, price: float, quantity: int, category: str, unit: str, description: str = ""):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute(
        "INSERT INTO products (name, price, quantity, category, unit, description) VALUES (?, ?, ?, ?, ?, ?)",
        (name, price, quantity, category, unit, description)
    )
    conn.commit()
    conn.close()

def update_product_name(product_id: int, name: str):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE products SET name = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
        (name, product_id)
    )
    conn.commit()
    conn.close()

def update_product_price(product_id: int, price: float):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE products SET price = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
        (price, product_id)
    )
    conn.commit()
    conn.close()

def update_product_quantity(product_id: int, quantity: int):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE products SET quantity = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
        (quantity, product_id)
    )
    conn.commit()
    conn.close()

def update_product_category(product_id: int, category: str):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE products SET category = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
        (category, product_id)
    )
    conn.commit()
    conn.close()

def update_product_unit(product_id: int, unit: str):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE products SET unit = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
        (unit, product_id)
    )
    conn.commit()
    conn.close()

def update_product_description(product_id: int, description: str):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE products SET description = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
        (description, product_id)
    )
    conn.commit()
    conn.close()

def delete_product(product_id: int):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute("DELETE FROM products WHERE id = ?", (product_id,))
    conn.commit()
    conn.close()

def is_admin(user_id: int):
    return user_id in ADMIN_IDS

def is_staff(user_id: int):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM staff WHERE user_id = ?", (user_id,))
    result = cursor.fetchone() is not None
    conn.close()
    return result or is_admin(user_id)

def add_staff(user_id: int, username: str = None, full_name: str = None, added_by: int = None):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    try:
        cursor.execute(
            "INSERT INTO staff (user_id, username, full_name, added_by) VALUES (?, ?, ?, ?)",
            (user_id, username, full_name, added_by)
        )
        conn.commit()
        success = True
    except sqlite3.IntegrityError:
        success = False
    conn.close()
    return success

def get_all_staff():
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM staff ORDER BY added_at DESC")
    staff = cursor.fetchall()
    conn.close()
    return staff

def remove_staff(user_id: int):
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    cursor.execute("DELETE FROM staff WHERE user_id = ?", (user_id,))
    conn.commit()
    conn.close()

def get_detailed_stats():
    conn = sqlite3.connect('stroygrad.db')
    cursor = conn.cursor()
    
    # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    cursor.execute("SELECT COUNT(*) FROM products")
    total_products = cursor.fetchone()[0]
    
    cursor.execute("SELECT COUNT(*) FROM staff")
    total_staff = cursor.fetchone()[0]
    
    cursor.execute("SELECT COUNT(*) FROM audit_log")
    total_actions = cursor.fetchone()[0]
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    cursor.execute("""
        SELECT category, COUNT(*) as count, SUM(quantity) as total_quantity, 
               SUM(price * quantity) as total_value 
        FROM products 
        GROUP BY category 
        ORDER BY total_value DESC
    """)
    category_stats = cursor.fetchall()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    cursor.execute("""
        SELECT action, COUNT(*) as count 
        FROM audit_log 
        GROUP BY action 
        ORDER BY count DESC
    """)
    activity_stats = cursor.fetchall()
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
    cursor.execute("SELECT * FROM audit_log ORDER BY created_at DESC LIMIT 5")
    recent_actions = cursor.fetchall()
    
    conn.close()
    
    return {
        'total_products': total_products,
        'total_staff': total_staff,
        'total_actions': total_actions,
        'category_stats': category_stats,
        'activity_stats': activity_stats,
        'recent_actions': recent_actions
    }

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
def calculate_bricks_advanced(params: dict) -> dict:
    """–†–∞—Å—á–µ—Ç –∫–∏—Ä–ø–∏—á–∞ –ø–æ —Ñ–æ—Ä–º—É–ª–µ stroy-calc.ru"""
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        required = ['brick_length', 'brick_width', 'brick_height', 'perimeter', 'wall_height', 'wall_thickness', 'mortar_thickness']
        for param in required:
            if param not in params:
                return {"error": f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä: {param}"}
        
        # –†–∞–∑–º–µ—Ä—ã –∫–∏—Ä–ø–∏—á–∞ –≤ –º–µ—Ç—Ä–∞—Ö
        brick_length = params['brick_length'] / 1000.0
        brick_width = params['brick_width'] / 1000.0
        brick_height = params['brick_height'] / 1000.0
        
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–æ–µ–Ω–∏—è
        perimeter = params['perimeter']
        wall_height = params['wall_height'] / 100.0  # —Å–º –≤ –º–µ—Ç—Ä—ã
        mortar_thickness = params['mortar_thickness'] / 1000.0  # –º–º –≤ –º–µ—Ç—Ä—ã
        
        # –†–∞–∑–º–µ—Ä—ã –∫–∏—Ä–ø–∏—á–∞ —Å —Ä–∞—Å—Ç–≤–æ—Ä–æ–º
        brick_with_mortar_length = brick_length + mortar_thickness
        brick_with_mortar_height = brick_height + mortar_thickness
        
        # –†–∞—Å—á–µ—Ç —Ç–æ–ª—â–∏–Ω—ã —Å—Ç–µ–Ω—ã
        wall_thickness = params['wall_thickness']
        if wall_thickness == 0.5:  # –ø–æ–ª–æ–≤–∏–Ω–∞ –∫–∏—Ä–ø–∏—á–∞
            actual_wall_thickness = brick_width
        elif wall_thickness == 1.0:  # —Ü–µ–ª—ã–π –∫–∏—Ä–ø–∏—á
            actual_wall_thickness = brick_length
        elif wall_thickness == 1.5:  # –ø–æ–ª—Ç–æ—Ä–∞ –∫–∏—Ä–ø–∏—á–∞
            actual_wall_thickness = brick_width + brick_length
        elif wall_thickness == 2.0:  # –¥–≤–∞ –∫–∏—Ä–ø–∏—á–∞
            actual_wall_thickness = 2 * brick_length
        else:
            actual_wall_thickness = brick_length
        
        # –ü–ª–æ—â–∞–¥—å —Å—Ç–µ–Ω
        wall_area = perimeter * wall_height
        
        # –í—ã—á–∏—Ç–∞–µ–º –ø—Ä–æ–µ–º—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        openings_area = 0
        if 'openings' in params and params['openings']:
            for opening in params['openings']:
                opening_area = (opening['width'] / 100.0) * (opening['height'] / 100.0) * opening['count']
                openings_area += opening_area
        
        # –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∫–ª–∞–¥–∫–∏
        total_area = wall_area - openings_area
        
        if total_area <= 0:
            return {"error": "–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∫–ª–∞–¥–∫–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π"}
        
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∏—Ä–ø–∏—á–µ–π –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–º –º–µ—Ç—Ä–µ
        bricks_per_square_meter = 1 / (brick_with_mortar_length * brick_with_mortar_height)
        
        # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∏—Ä–ø–∏—á–µ–π
        bricks_needed = total_area * bricks_per_square_meter
        
        # –û–±—ä–µ–º –∫–ª–∞–¥–∫–∏
        wall_volume = total_area * actual_wall_thickness
        
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∏—Ä–ø–∏—á–µ–π –≤ –∫—É–±–µ
        brick_volume = brick_length * brick_width * brick_height
        bricks_per_cube = 1.0 / brick_volume
        
        # –û–±—â–∏–π –æ–±—ä–µ–º –∫–∏—Ä–ø–∏—á–∞
        total_brick_volume = bricks_needed * brick_volume
        
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—è–¥–æ–≤
        rows_count = wall_height / brick_with_mortar_height
        
        # –û–±—ä–µ–º —Ä–∞—Å—Ç–≤–æ—Ä–∞ (25% –æ—Ç –æ–±—ä–µ–º–∞ –∫–ª–∞–¥–∫–∏)
        mortar_volume = wall_volume * 0.25
        
        # –ö–ª–∞–¥–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞
        mesh_length = 0
        if 'mesh_frequency' in params and params['mesh_frequency'] > 0:
            mesh_rows = rows_count / params['mesh_frequency']
            mesh_length = mesh_rows * perimeter
        
        # –í–µ—Å –∫–∏—Ä–ø–∏—á–µ–π
        brick_weight = params.get('brick_weight', 3.5)  # –∫–≥
        if 'brick_pulsatility' in params and params['brick_pulsatility'] > 0:
            # –£—á–µ—Ç –ø—É—Å—Ç–æ—Ç–Ω–æ—Å—Ç–∏
            solid_fraction = 1 - (params['brick_pulsatility'] / 100.0)
            brick_weight *= solid_fraction
        
        total_weight = bricks_needed * brick_weight
        
        # –í–µ—Å —Ä–∞—Å—Ç–≤–æ—Ä–∞ (–ø–ª–æ—Ç–Ω–æ—Å—Ç—å 1900 –∫–≥/–º¬≥)
        mortar_weight = mortar_volume * 1900
        
        # –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
        foundation_area = perimeter * 100 * actual_wall_thickness * 100  # —Å–º¬≤
        foundation_load = (total_weight + mortar_weight) / foundation_area if foundation_area > 0 else 0
        
        # –°—Ç–æ–∏–º–æ—Å—Ç—å
        total_cost = bricks_needed * params.get('price', 0)
        
        # –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω—ã
        optimal_height = math.floor(wall_height / brick_with_mortar_height) * brick_with_mortar_height * 100
        
        return {
            'material_type': '–∫–∏—Ä–ø–∏—á',
            'brick_dimensions': f"{params['brick_length']}√ó{params['brick_width']}√ó{params['brick_height']} –º–º",
            'perimeter': perimeter,
            'wall_area': round(total_area, 2),
            'wall_thickness': round(actual_wall_thickness * 1000),
            'bricks_needed': round(bricks_needed),
            'brick_weight': round(brick_weight, 2),
            'total_weight': round(total_weight),
            'total_volume': round(total_brick_volume, 2),
            'bricks_per_cube': round(bricks_per_cube),
            'mortar_volume': round(mortar_volume, 3),
            'mortar_weight': round(mortar_weight),
            'rows_count': round(rows_count),
            'mesh_length': round(mesh_length, 1),
            'optimal_height': round(optimal_height),
            'foundation_load': round(foundation_load, 2),
            'total_cost': round(total_cost, 2),
            'total_wall_weight': round(total_weight + mortar_weight)
        }
        
    except Exception as e:
        return {"error": f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –∫–∏—Ä–ø–∏—á–∞: {str(e)}"}

def calculate_wall_blocks_advanced(params: dict) -> dict:
    """–†–∞—Å—á–µ—Ç —Å—Ç–µ–Ω–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤ –ø–æ —Ñ–æ—Ä–º—É–ª–µ stroy-calc.ru"""
    try:
        required = ['block_length', 'block_width', 'block_height', 'perimeter', 'wall_height', 'wall_thickness', 'mortar_thickness']
        for param in required:
            if param not in params:
                return {"error": f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä: {param}"}
        
        # –†–∞–∑–º–µ—Ä—ã –±–ª–æ–∫–∞ –≤ –º–µ—Ç—Ä–∞—Ö
        block_length = params['block_length'] / 1000.0
        block_width = params['block_width'] / 1000.0
        block_height = params['block_height'] / 1000.0
        
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–æ–µ–Ω–∏—è
        perimeter = params['perimeter']
        wall_height = params['wall_height'] / 100.0
        mortar_thickness = params['mortar_thickness'] / 1000.0
        
        # –†–∞–∑–º–µ—Ä—ã –±–ª–æ–∫–∞ —Å —Ä–∞—Å—Ç–≤–æ—Ä–æ–º
        block_with_mortar_length = block_length + mortar_thickness
        block_with_mortar_height = block_height + mortar_thickness
        
        # –†–∞—Å—á–µ—Ç —Ç–æ–ª—â–∏–Ω—ã —Å—Ç–µ–Ω—ã
        wall_thickness = params['wall_thickness']
        if wall_thickness == 0.5:  # –ø–æ–ª–æ–≤–∏–Ω–∞ –±–ª–æ–∫–∞
            actual_wall_thickness = block_width
        elif wall_thickness == 1.0:  # —Ü–µ–ª—ã–π –±–ª–æ–∫
            actual_wall_thickness = block_length
        elif wall_thickness == 1.5:  # –ø–æ–ª—Ç–æ—Ä–∞ –±–ª–æ–∫–∞
            actual_wall_thickness = block_width + block_length
        elif wall_thickness == 2.0:  # –¥–≤–∞ –±–ª–æ–∫–∞
            actual_wall_thickness = 2 * block_length
        else:
            actual_wall_thickness = block_length
        
        # –ü–ª–æ—â–∞–¥—å —Å—Ç–µ–Ω
        wall_area = perimeter * wall_height
        
        # –í—ã—á–∏—Ç–∞–µ–º –ø—Ä–æ–µ–º—ã
        openings_area = 0
        if 'openings' in params and params['openings']:
            for opening in params['openings']:
                opening_area = (opening['width'] / 100.0) * (opening['height'] / 100.0) * opening['count']
                openings_area += opening_area
        
        total_area = wall_area - openings_area
        
        if total_area <= 0:
            return {"error": "–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∫–ª–∞–¥–∫–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π"}
        
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–º –º–µ—Ç—Ä–µ
        blocks_per_square_meter = 1 / (block_with_mortar_length * block_with_mortar_height)
        
        # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤
        blocks_needed = total_area * blocks_per_square_meter
        
        # –û–±—ä–µ–º –∫–ª–∞–¥–∫–∏
        wall_volume = total_area * actual_wall_thickness
        
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ –≤ –∫—É–±–µ
        block_volume = block_length * block_width * block_height
        blocks_per_cube = 1.0 / block_volume
        
        # –û–±—â–∏–π –æ–±—ä–µ–º –±–ª–æ–∫–æ–≤
        total_volume = blocks_needed * block_volume
        
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—è–¥–æ–≤
        rows_count = wall_height / block_with_mortar_height
        
        # –û–±—ä–µ–º —Ä–∞—Å—Ç–≤–æ—Ä–∞ (20% –æ—Ç –æ–±—ä–µ–º–∞ –∫–ª–∞–¥–∫–∏)
        mortar_volume = wall_volume * 0.20
        
        # –ö–ª–∞–¥–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞
        mesh_length = 0
        if 'mesh_frequency' in params and params['mesh_frequency'] > 0:
            mesh_rows = rows_count / params['mesh_frequency']
            mesh_length = mesh_rows * perimeter
        
        # –í–µ—Å –±–ª–æ–∫–æ–≤
        block_weight = params.get('block_weight', 16.0)  # –∫–≥
        total_weight = blocks_needed * block_weight
        
        # –í–µ—Å —Ä–∞—Å—Ç–≤–æ—Ä–∞
        mortar_weight = mortar_volume * 1900
        
        # –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
        foundation_area = perimeter * 100 * actual_wall_thickness * 100
        foundation_load = (total_weight + mortar_weight) / foundation_area if foundation_area > 0 else 0
        
        # –°—Ç–æ–∏–º–æ—Å—Ç—å
        total_cost = blocks_needed * params.get('price', 0)
        
        # –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞
        optimal_height = math.floor(wall_height / block_with_mortar_height) * block_with_mortar_height * 100
        
        return {
            'material_type': '—Å—Ç–µ–Ω–æ–≤—ã–µ –±–ª–æ–∫–∏',
            'block_dimensions': f"{params['block_length']}√ó{params['block_width']}√ó{params['block_height']} –º–º",
            'perimeter': perimeter,
            'wall_area': round(total_area, 2),
            'wall_thickness': round(actual_wall_thickness * 1000),
            'blocks_needed': round(blocks_needed),
            'block_weight': round(block_weight, 2),
            'total_weight': round(total_weight),
            'total_volume': round(total_volume, 2),
            'blocks_per_cube': round(blocks_per_cube),
            'mortar_volume': round(mortar_volume, 3),
            'mortar_weight': round(mortar_weight),
            'rows_count': round(rows_count),
            'mesh_length': round(mesh_length, 1),
            'optimal_height': round(optimal_height),
            'foundation_load': round(foundation_load, 2),
            'total_cost': round(total_cost, 2),
            'total_wall_weight': round(total_weight + mortar_weight)
        }
        
    except Exception as e:
        return {"error": f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–µ–Ω–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤: {str(e)}"}

def calculate_foam_blocks_advanced(params: dict) -> dict:
    """–†–∞—Å—á–µ—Ç –ø–µ–Ω–æ–±–ª–æ–∫–æ–≤ –ø–æ —Ñ–æ—Ä–º—É–ª–µ stroy-calc.ru"""
    try:
        required = ['block_length', 'block_width', 'block_height', 'density', 'perimeter', 'wall_height', 'wall_thickness', 'mortar_thickness']
        for param in required:
            if param not in params:
                return {"error": f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä: {param}"}
        
        # –†–∞–∑–º–µ—Ä—ã –±–ª–æ–∫–∞ –≤ –º–µ—Ç—Ä–∞—Ö
        block_length = params['block_length'] / 1000.0
        block_width = params['block_width'] / 1000.0
        block_height = params['block_height'] / 1000.0
        
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–æ–µ–Ω–∏—è
        perimeter = params['perimeter']
        wall_height = params['wall_height'] / 100.0
        density = params['density']
        mortar_thickness = params['mortar_thickness'] / 1000.0
        
        # –†–∞–∑–º–µ—Ä—ã —Å —Ä–∞—Å—Ç–≤–æ—Ä–æ–º
        block_with_mortar_length = block_length + mortar_thickness
        block_with_mortar_height = block_height + mortar_thickness
        
        # –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω—ã
        wall_thickness = params['wall_thickness']
        if wall_thickness == 0.5:
            actual_wall_thickness = block_width
        elif wall_thickness == 1.0:
            actual_wall_thickness = block_length
        elif wall_thickness == 1.5:
            actual_wall_thickness = block_width + block_length
        elif wall_thickness == 2.0:
            actual_wall_thickness = 2 * block_length
        else:
            actual_wall_thickness = block_length
        
        # –ü–ª–æ—â–∞–¥—å —Å—Ç–µ–Ω
        wall_area = perimeter * wall_height
        
        # –ü—Ä–æ–µ–º—ã
        openings_area = 0
        if 'openings' in params and params['openings']:
            for opening in params['openings']:
                opening_area = (opening['width'] / 100.0) * (opening['height'] / 100.0) * opening['count']
                openings_area += opening_area
        
        total_area = wall_area - openings_area
        
        if total_area <= 0:
            return {"error": "–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∫–ª–∞–¥–∫–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π"}
        
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ –≤ –º¬≤
        blocks_per_square_meter = 1 / (block_with_mortar_length * block_with_mortar_height)
        blocks_needed = total_area * blocks_per_square_meter
        
        # –û–±—ä–µ–º–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã
        block_volume = block_length * block_width * block_height
        blocks_per_cube = 1.0 / block_volume
        total_volume = blocks_needed * block_volume
        
        # –û–±—ä–µ–º –∫–ª–∞–¥–∫–∏ –∏ —Ä–∞—Å—Ç–≤–æ—Ä–∞
        wall_volume = total_area * actual_wall_thickness
        mortar_volume = wall_volume * 0.15  # 15% –¥–ª—è –ø–µ–Ω–æ–±–ª–æ–∫–æ–≤
        
        # –†—è–¥—ã –∏ —Å–µ—Ç–∫–∞
        rows_count = wall_height / block_with_mortar_height
        mesh_length = 0
        if 'mesh_frequency' in params and params['mesh_frequency'] > 0:
            mesh_rows = rows_count / params['mesh_frequency']
            mesh_length = mesh_rows * perimeter
        
        # –í–µ—Å
        block_weight = block_volume * density
        total_weight = blocks_needed * block_weight
        mortar_weight = mortar_volume * 1900
        
        # –ù–∞–≥—Ä—É–∑–∫–∞
        foundation_area = perimeter * 100 * actual_wall_thickness * 100
        foundation_load = (total_weight + mortar_weight) / foundation_area if foundation_area > 0 else 0
        
        # –°—Ç–æ–∏–º–æ—Å—Ç—å
        total_cost = total_volume * params.get('price_per_cube', 0)
        
        # –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞
        optimal_height = math.floor(wall_height / block_with_mortar_height) * block_with_mortar_height * 100
        
        return {
            'material_type': '–ø–µ–Ω–æ–±–ª–æ–∫–∏',
            'block_dimensions': f"{params['block_length']}√ó{params['block_width']}√ó{params['block_height']} –º–º",
            'density': f"D{density}",
            'perimeter': perimeter,
            'wall_area': round(total_area, 2),
            'wall_thickness': round(actual_wall_thickness * 1000),
            'blocks_needed': round(blocks_needed),
            'block_weight': round(block_weight, 2),
            'total_weight': round(total_weight),
            'total_volume': round(total_volume, 2),
            'blocks_per_cube': round(blocks_per_cube),
            'mortar_volume': round(mortar_volume, 3),
            'mortar_weight': round(mortar_weight),
            'rows_count': round(rows_count),
            'mesh_length': round(mesh_length, 1),
            'optimal_height': round(optimal_height),
            'foundation_load': round(foundation_load, 2),
            'total_cost': round(total_cost, 2),
            'total_wall_weight': round(total_weight + mortar_weight)
        }
        
    except Exception as e:
        return {"error": f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –ø–µ–Ω–æ–±–ª–æ–∫–æ–≤: {str(e)}"}

def calculate_gas_blocks_advanced(params: dict) -> dict:
    """–†–∞—Å—á–µ—Ç –≥–∞–∑–æ–±–µ—Ç–æ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–µ–Ω–æ–±–ª–æ–∫–∞–º)"""
    return calculate_foam_blocks_advanced(params)

def calculate_ceramic_blocks_advanced(params: dict) -> dict:
    """–†–∞—Å—á–µ—Ç –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤ –ø–æ —Ñ–æ—Ä–º—É–ª–µ stroy-calc.ru"""
    try:
        required = ['block_length', 'block_width', 'block_height', 'perimeter', 'wall_height', 'wall_thickness', 'mortar_thickness']
        for param in required:
            if param not in params:
                return {"error": f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä: {param}"}
        
        # –†–∞–∑–º–µ—Ä—ã –±–ª–æ–∫–∞ –≤ –º–µ—Ç—Ä–∞—Ö
        block_length = params['block_length'] / 1000.0
        block_width = params['block_width'] / 1000.0
        block_height = params['block_height'] / 1000.0
        
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–æ–µ–Ω–∏—è
        perimeter = params['perimeter']
        wall_height = params['wall_height'] / 100.0
        mortar_thickness = params['mortar_thickness'] / 1000.0
        
        # –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤ - –ø–∞–∑-–≥—Ä–µ–±–µ–Ω—å
        block_with_mortar_length = block_length + mortar_thickness
        block_with_mortar_height = block_height + mortar_thickness
        
        # –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω—ã (–¥–ª—è –∫–µ—Ä–∞–º–∏–∫–∏ –æ–±—ã—á–Ω–æ –≤ –±–ª–æ–∫–∞—Ö)
        wall_thickness = params['wall_thickness']
        if wall_thickness == 0.5:
            actual_wall_thickness = block_width
        elif wall_thickness == 1.0:
            actual_wall_thickness = block_width  # –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å –∫–µ—Ä–∞–º–∏–∫–∏
        elif wall_thickness == 1.5:
            actual_wall_thickness = 1.5 * block_width
        elif wall_thickness == 2.0:
            actual_wall_thickness = 2 * block_width
        else:
            actual_wall_thickness = block_width
        
        # –ü–ª–æ—â–∞–¥—å —Å—Ç–µ–Ω
        wall_area = perimeter * wall_height
        
        # –ü—Ä–æ–µ–º—ã
        openings_area = 0
        if 'openings' in params and params['openings']:
            for opening in params['openings']:
                opening_area = (opening['width'] / 100.0) * (opening['height'] / 100.0) * opening['count']
                openings_area += opening_area
        
        total_area = wall_area - openings_area
        
        if total_area <= 0:
            return {"error": "–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∫–ª–∞–¥–∫–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π"}
        
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤
        blocks_per_square_meter = 1 / (block_with_mortar_length * block_with_mortar_height)
        blocks_needed = total_area * blocks_per_square_meter
        
        # –û–±—ä–µ–º–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã
        block_volume = block_length * block_width * block_height
        blocks_per_cube = 1.0 / block_volume
        total_volume = blocks_needed * block_volume
        
        # –û–±—ä–µ–º —Ä–∞—Å—Ç–≤–æ—Ä–∞ (–º–µ–Ω—å—à–µ –¥–ª—è –∫–µ—Ä–∞–º–∏–∫–∏ - 5%)
        wall_volume = total_area * actual_wall_thickness
        mortar_volume = wall_volume * 0.05
        
        # –†—è–¥—ã –∏ —Å–µ—Ç–∫–∞
        rows_count = wall_height / block_with_mortar_height
        mesh_length = 0
        if 'mesh_frequency' in params and params['mesh_frequency'] > 0:
            mesh_rows = rows_count / params['mesh_frequency']
            mesh_length = mesh_rows * perimeter
        
        # –í–µ—Å (–∫–µ—Ä–∞–º–∏–∫–∞ –ø–ª–æ—Ç–Ω–µ–µ)
        block_weight = params.get('block_weight', block_volume * 800)  # ~800 –∫–≥/–º¬≥
        total_weight = blocks_needed * block_weight
        mortar_weight = mortar_volume * 1900
        
        # –ù–∞–≥—Ä—É–∑–∫–∞
        foundation_area = perimeter * 100 * actual_wall_thickness * 100
        foundation_load = (total_weight + mortar_weight) / foundation_area if foundation_area > 0 else 0
        
        # –°—Ç–æ–∏–º–æ—Å—Ç—å
        total_cost = blocks_needed * params.get('price', 0)
        
        # –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞
        optimal_height = math.floor(wall_height / block_with_mortar_height) * block_with_mortar_height * 100
        
        return {
            'material_type': '–∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏',
            'block_dimensions': f"{params['block_length']}√ó{params['block_width']}√ó{params['block_height']} –º–º",
            'perimeter': perimeter,
            'wall_area': round(total_area, 2),
            'wall_thickness': round(actual_wall_thickness * 1000),
            'blocks_needed': round(blocks_needed),
            'block_weight': round(block_weight, 2),
            'total_weight': round(total_weight),
            'total_volume': round(total_volume, 2),
            'blocks_per_cube': round(blocks_per_cube),
            'mortar_volume': round(mortar_volume, 3),
            'mortar_weight': round(mortar_weight),
            'rows_count': round(rows_count),
            'mesh_length': round(mesh_length, 1),
            'optimal_height': round(optimal_height),
            'foundation_load': round(foundation_load, 2),
            'total_cost': round(total_cost, 2),
            'total_wall_weight': round(total_weight + mortar_weight)
        }
        
    except Exception as e:
        return {"error": f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤: {str(e)}"}

def perform_simple_calculation(material_type: str, length: float, width: float, height: float) -> dict:
    """–ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Ä–∞–∑–º–µ—Ä–∞–º"""
    
    # –û–±—ä–µ–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    volume = length * width * height
    
    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–≤ –º–µ—Ç—Ä–∞—Ö)
    standard_sizes = {
        "bricks": {
            "length": 0.25, "width": 0.12, "height": 0.065,
            "name": "–ö–∏—Ä–ø–∏—á –æ–¥–∏–Ω–∞—Ä–Ω—ã–π", "per_cube": 394
        },
        "gas_blocks": {
            "length": 0.625, "width": 0.25, "height": 0.25, 
            "name": "–ì–∞–∑–æ–±–µ—Ç–æ–Ω–Ω—ã–π –±–ª–æ–∫", "per_cube": 26
        },
        "foam_blocks": {
            "length": 0.6, "width": 0.3, "height": 0.2,
            "name": "–ü–µ–Ω–æ–±–ª–æ–∫", "per_cube": 28
        },
        "ceramic_blocks": {
            "length": 0.51, "width": 0.25, "height": 0.219,
            "name": "–ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–π –±–ª–æ–∫", "per_cube": 36
        }
    }
    
    material_info = standard_sizes.get(material_type, standard_sizes["bricks"])
    
    # –†–∞—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    material_volume = material_info["length"] * material_info["width"] * material_info["height"]
    quantity = int(volume / material_volume)
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã
    per_cube = material_info["per_cube"]
    cubes_needed = volume
    
    return {
        "material_name": material_info["name"],
        "material_size": f"{int(material_info['length']*1000)}√ó{int(material_info['width']*1000)}√ó{int(material_info['height']*1000)} mm",
        "volume": round(volume, 3),
        "quantity": quantity,
        "per_cube": per_cube,
        "cubes_needed": round(cubes_needed, 2)
    }

def format_simple_calculation_result(result: dict, material_type: str, length: float, width: float, height: float) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞"""
    
    material_names = {
        "bricks": "–ö–∏—Ä–ø–∏—á –æ–¥–∏–Ω–∞—Ä–Ω—ã–π",
        "gas_blocks": "–ì–∞–∑–æ–±–µ—Ç–æ–Ω–Ω—ã–π –±–ª–æ–∫", 
        "foam_blocks": "–ü–µ–Ω–æ–±–ª–æ–∫",
        "ceramic_blocks": "–ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–π –±–ª–æ–∫"
    }
    
    material_name = material_names.get(material_type, "–ú–∞—Ç–µ—Ä–∏–∞–ª")
    
    text = f"""
‚ö° –ü–†–û–°–¢–û–ô –†–ê–°–ß–ï–¢ - –†–ï–ó–£–õ–¨–¢–ê–¢

üìè <b>–†–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</b>
‚Ä¢ {length} √ó {width} √ó {height} –º
‚Ä¢ –û–±—ä–µ–º: {result['volume']} –º¬≥

üß± <b>–ú–∞—Ç–µ—Ä–∏–∞–ª:</b>
‚Ä¢ {material_name}
‚Ä¢ –†–∞–∑–º–µ—Ä: {result['material_size']}

üìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b>
‚Ä¢ <b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {result['quantity']} —à—Ç—É–∫</b>
‚Ä¢ –í 1 –º¬≥: {result['per_cube']} —à—Ç.
‚Ä¢ –ö—É–±–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: {result['cubes_needed']} –º¬≥

üí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>
‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ 5-10% –Ω–∞ –ø–æ–¥—Ä–µ–∑–∫—É –∏ –±–æ–π
‚Ä¢ –î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
‚Ä¢ –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –ø—Ä–æ–µ–º—ã –æ–∫–æ–Ω –∏ –¥–≤–µ—Ä–µ–π

<i>–≠—Ç–æ –±–∞–∑–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç. –î–ª—è —É—á–µ—Ç–∞ —Ñ—Ä–æ–Ω—Ç–æ–Ω–æ–≤, –ø—Ä–æ–µ–º–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç.</i>
"""
    return text

def format_bricks_result(result: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è –∫–∏—Ä–ø–∏—á–∞"""
    return f"""
üß± –†–ê–°–ß–ï–¢ –ö–ò–†–ü–ò–ß–ê

üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞:

| –ü–µ—Ä–∏–º–µ—Ç—Ä —Å—Ç—Ä–æ–µ–Ω–∏—è    | {result['perimeter']} | –º–µ—Ç—Ä–æ–≤ |
| –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∫–ª–∞–¥–∫–∏ | {result['wall_area']} | –º¬≤ |
| –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω—ã        | {result['wall_thickness']} | –º–º |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∏—Ä–ø–∏—á–∞   | {result['bricks_needed']} | —à—Ç |
| –í–µ—Å 1 –∫–∏—Ä–ø–∏—á–∞        | {result['brick_weight']} | –∫–≥ |
| –û–±—â–∏–π –≤–µ—Å –∫–∏—Ä–ø–∏—á–∞    | {result['total_weight']} | –∫–≥ |
| –û–±—â–∏–π –æ–±—ä–µ–º –∫–∏—Ä–ø–∏—á–∞  | {result['total_volume']} | –º¬≥ |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∏—Ä–ø–∏—á–∞ –≤ –∫—É–±–µ | {result['bricks_per_cube']} | —à—Ç/–º¬≥ |
| –ö–æ–ª-–≤–æ —Ä–∞—Å—Ç–≤–æ—Ä–∞ –Ω–∞ –≤—Å—é –∫–ª–∞–¥–∫—É | {result['mortar_volume']} | –º¬≥ |
| –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å —Ä–∞—Å—Ç–≤–æ—Ä–∞ | {result['mortar_weight']} | –∫–≥ |
| –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω—ã | {result['optimal_height']} | —Å–º |
| –ö–æ–ª-–≤–æ —Ä—è–¥–æ–≤ –∫–∏—Ä–ø–∏—á–∞ —Å —É—á–µ—Ç–æ–º —à–≤–æ–≤ | {result['rows_count']} | —Ä—è–¥–æ–≤ |
| –ö–æ–ª-–≤–æ –∫–ª–∞–¥–æ—á–Ω–æ–π —Å–µ—Ç–∫–∏ | {result['mesh_length']} | –º–µ—Ç—Ä–æ–≤ |
| –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å –≥–æ—Ç–æ–≤—ã—Ö —Å—Ç–µ–Ω | {result['total_wall_weight']} | –∫–≥ |
| –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –æ—Ç —Å—Ç–µ–Ω | {result['foundation_load']} | –∫–≥/—Å–º¬≤ |

üìè –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞:
‚Ä¢ –†–∞–∑–º–µ—Ä—ã: {result['brick_dimensions']}

üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ 5-7% –Ω–∞ –ø–æ–¥—Ä–µ–∑–∫—É –∏ –±–æ–π
‚Ä¢ –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
‚Ä¢ –î–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –∑–∞–º–µ—Ä—å—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑–º–µ—Ä—ã –∫–∏—Ä–ø–∏—á–∞
"""

def format_wall_blocks_result(result: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å—Ç–µ–Ω–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤"""
    return f"""
üèóÔ∏è –†–ê–°–ß–ï–¢ –°–¢–ï–ù–û–í–´–• –ë–õ–û–ö–û–í

üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞:

| –ü–µ—Ä–∏–º–µ—Ç—Ä —Å—Ç—Ä–æ–µ–Ω–∏—è    | {result['perimeter']} | –º–µ—Ç—Ä–æ–≤ |
| –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∫–ª–∞–¥–∫–∏ | {result['wall_area']} | –º¬≤ |
| –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω—ã        | {result['wall_thickness']} | –º–º |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤    | {result['blocks_needed']} | —à—Ç |
| –û–±—â–∏–π –≤–µ—Å –±–ª–æ–∫–æ–≤     | {result['total_weight']} | –∫–≥ |
| –û–±—â–∏–π –æ–±—ä–µ–º –±–ª–æ–∫–æ–≤   | {result['total_volume']} | –º¬≥ |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ –≤ –∫—É–±–µ | {result['blocks_per_cube']} | —à—Ç/–º¬≥ |
| –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –±–ª–æ–∫–æ–≤ | {result['total_cost']} | —Ä—É–± |
| –ö–æ–ª-–≤–æ —Ä–∞—Å—Ç–≤–æ—Ä–∞ –Ω–∞ –≤—Å—é –∫–ª–∞–¥–∫—É | {result['mortar_volume']} | –º¬≥ |
| –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å —Ä–∞—Å—Ç–≤–æ—Ä–∞ | {result['mortar_weight']} | –∫–≥ |
| –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω—ã | {result['optimal_height']} | —Å–º |
| –ö–æ–ª-–≤–æ —Ä—è–¥–æ–≤ –±–ª–æ–∫–æ–≤ —Å —É—á–µ—Ç–æ–º —à–≤–æ–≤ | {result['rows_count']} | —Ä—è–¥–æ–≤ |
| –ö–æ–ª-–≤–æ –∫–ª–∞–¥–æ—á–Ω–æ–π —Å–µ—Ç–∫–∏ | {result['mesh_length']} | –º–µ—Ç—Ä–æ–≤ |
| –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å –≥–æ—Ç–æ–≤—ã—Ö —Å—Ç–µ–Ω | {result['total_wall_weight']} | –∫–≥ |
| –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –æ—Ç —Å—Ç–µ–Ω | {result['foundation_load']} | –∫–≥/—Å–º¬≤ |

üìè –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞:
‚Ä¢ –†–∞–∑–º–µ—Ä—ã: {result['block_dimensions']}
‚Ä¢ –í–µ—Å 1 –±–ª–æ–∫–∞: {result['block_weight']} –∫–≥

üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ 5-7% –Ω–∞ –ø–æ–¥—Ä–µ–∑–∫—É –∏ –±–æ–π
‚Ä¢ –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
‚Ä¢ –î–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –∑–∞–º–µ—Ä—å—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑–º–µ—Ä—ã –±–ª–æ–∫–æ–≤
"""

def format_foam_blocks_result(result: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è –ø–µ–Ω–æ–±–ª–æ–∫–æ–≤"""
    return f"""
üß± –†–ê–°–ß–ï–¢ –ü–ï–ù–û–ë–õ–û–ö–û–í

üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞:

| –ü–µ—Ä–∏–º–µ—Ç—Ä —Å—Ç—Ä–æ–µ–Ω–∏—è    | {result['perimeter']} | –º–µ—Ç—Ä–æ–≤ |
| –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∫–ª–∞–¥–∫–∏ | {result['wall_area']} | –º¬≤ |
| –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω—ã        | {result['wall_thickness']} | –º–º |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤    | {result['blocks_needed']} | —à—Ç |
| –û–±—â–∏–π –≤–µ—Å –±–ª–æ–∫–æ–≤     | {result['total_weight']} | –∫–≥ |
| –û–±—â–∏–π –æ–±—ä–µ–º –±–ª–æ–∫–æ–≤   | {result['total_volume']} | –º¬≥ |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ –≤ –∫—É–±–µ | {result['blocks_per_cube']} | —à—Ç/–º¬≥ |
| –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –±–ª–æ–∫–æ–≤ | {result['total_cost']} | —Ä—É–± |
| –ö–æ–ª-–≤–æ —Ä–∞—Å—Ç–≤–æ—Ä–∞ –Ω–∞ –≤—Å—é –∫–ª–∞–¥–∫—É | {result['mortar_volume']} | –º¬≥ |
| –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å —Ä–∞—Å—Ç–≤–æ—Ä–∞ | {result['mortar_weight']} | –∫–≥ |
| –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω—ã | {result['optimal_height']} | —Å–º |
| –ö–æ–ª-–≤–æ —Ä—è–¥–æ–≤ –±–ª–æ–∫–æ–≤ —Å —É—á–µ—Ç–æ–º —à–≤–æ–≤ | {result['rows_count']} | —Ä—è–¥–æ–≤ |
| –ö–æ–ª-–≤–æ –∫–ª–∞–¥–æ—á–Ω–æ–π —Å–µ—Ç–∫–∏ | {result['mesh_length']} | –º–µ—Ç—Ä–æ–≤ |
| –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å –≥–æ—Ç–æ–≤—ã—Ö —Å—Ç–µ–Ω | {result['total_wall_weight']} | –∫–≥ |
| –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –æ—Ç —Å—Ç–µ–Ω | {result['foundation_load']} | –∫–≥/—Å–º¬≤ |

üìè –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞:
‚Ä¢ –†–∞–∑–º–µ—Ä—ã: {result['block_dimensions']}
‚Ä¢ –ü–ª–æ—Ç–Ω–æ—Å—Ç—å: {result['density']} –∫–≥/–º¬≥
‚Ä¢ –í–µ—Å 1 –±–ª–æ–∫–∞: {result['block_weight']} –∫–≥

üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ 5-7% –Ω–∞ –ø–æ–¥—Ä–µ–∑–∫—É –∏ –±–æ–π
‚Ä¢ –ü–µ–Ω–æ–±–ª–æ–∫–∏ —Ç—Ä–µ–±—É—é—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –≤–ª–∞–≥–∏
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–µ–π –¥–ª—è —Ç–æ–Ω–∫–∏—Ö —à–≤–æ–≤
‚Ä¢ –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –Ω–∏–∑–∫—É—é —Ç–µ–ø–ª–æ–ø—Ä–æ–≤–æ–¥–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Ç–æ–ª—â–∏–Ω—ã —Å—Ç–µ–Ω
"""

def format_gas_blocks_result(result: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è –≥–∞–∑–æ–±–µ—Ç–æ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤"""
    return f"""
üèóÔ∏è –†–ê–°–ß–ï–¢ –ì–ê–ó–û–ë–ï–¢–û–ù–ù–´–• –ë–õ–û–ö–û–í

üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞:

| –ü–µ—Ä–∏–º–µ—Ç—Ä —Å—Ç—Ä–æ–µ–Ω–∏—è    | {result['perimeter']} | –º–µ—Ç—Ä–æ–≤ |
| –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∫–ª–∞–¥–∫–∏ | {result['wall_area']} | –º¬≤ |
| –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω—ã        | {result['wall_thickness']} | –º–º |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤    | {result['blocks_needed']} | —à—Ç |
| –û–±—â–∏–π –≤–µ—Å –±–ª–æ–∫–æ–≤     | {result['total_weight']} | –∫–≥ |
‚Ä¢ –û–±—â–∏–π –æ–±—ä–µ–º –±–ª–æ–∫–æ–≤   | {result['total_volume']} | –º¬≥ |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ –≤ –∫—É–±–µ | {result['blocks_per_cube']} | —à—Ç/–º¬≥ |
| –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –±–ª–æ–∫–æ–≤ | {result['total_cost']} | —Ä—É–± |
| –ö–æ–ª-–≤–æ —Ä–∞—Å—Ç–≤–æ—Ä–∞ –Ω–∞ –≤—Å—é –∫–ª–∞–¥–∫—É | {result['mortar_volume']} | –º¬≥ |
| –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å —Ä–∞—Å—Ç–≤–æ—Ä–∞ | {result['mortar_weight']} | –∫–≥ |
| –†–∞—Å—á–µ—Ç–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω—ã —Å —É—á–µ—Ç–æ–º —à–≤–æ–≤ | {result['optimal_height']} | —Å–º |
| –ö–æ–ª-–≤–æ —Ä—è–¥–æ–≤ –±–ª–æ–∫–æ–≤ —Å —É—á–µ—Ç–æ–º —à–≤–æ–≤ | {result['rows_count']} | —Ä—è–¥–æ–≤ |
| –ö–æ–ª-–≤–æ –∫–ª–∞–¥–æ—á–Ω–æ–π —Å–µ—Ç–∫–∏ | {result['mesh_length']} | –º–µ—Ç—Ä–æ–≤ |
| –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å –≥–æ—Ç–æ–≤—ã—Ö —Å—Ç–µ–Ω | {result['total_wall_weight']} | –∫–≥ |
| –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –æ—Ç —Å—Ç–µ–Ω | {result['foundation_load']} | –∫–≥/—Å–º¬≤ |

üìè –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞:
‚Ä¢ –†–∞–∑–º–µ—Ä—ã: {result['block_dimensions']}
‚Ä¢ –ü–ª–æ—Ç–Ω–æ—Å—Ç—å: {result['density']} –∫–≥/–º¬≥
‚Ä¢ –í–µ—Å 1 –±–ª–æ–∫–∞: {result['block_weight']} –∫–≥

üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ 5-7% –Ω–∞ –ø–æ–¥—Ä–µ–∑–∫—É –∏ –±–æ–π
‚Ä¢ –ì–∞–∑–æ–±–µ—Ç–æ–Ω —Ç—Ä–µ–±—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ç–¥–µ–ª–∫–∏ –æ—Ç –≤–ª–∞–≥–∏
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–µ–π –¥–ª—è —Ç–æ–Ω–∫–∏—Ö —à–≤–æ–≤
‚Ä¢ –û—Ç–ª–∏—á–Ω–∞—è —Ç–µ–ø–ª–æ–∏–∑–æ–ª—è—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–µ–ª–∞—Ç—å —Å—Ç–µ–Ω—ã —Ç–æ–Ω—å—à–µ
‚Ä¢ –õ–µ–≥–∫–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª - –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
"""

def format_ceramic_blocks_result(result: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤"""
    return f"""
üß± –†–ê–°–ß–ï–¢ –ö–ï–†–ê–ú–ò–ß–ï–°–ö–ò–• –ë–õ–û–ö–û–í

üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞:

| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–µ—Ä–∞–º–æ–±–ª–æ–∫–æ–≤ | {result['blocks_needed']} | —à—Ç |
| –û–±—â–∏–π –æ–±—ä–µ–º –∫–µ—Ä–∞–º–æ–±–ª–æ–∫–æ–≤ | {result['total_volume']} | –º¬≥ |
| –ü–µ—Ä–∏–º–µ—Ç—Ä —Å—Ç—Ä–æ–µ–Ω–∏—è    | {result['perimeter']} | –º–µ—Ç—Ä–æ–≤ |
| –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∫–ª–∞–¥–∫–∏ | {result['wall_area']} | –º¬≤ |
| –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω—ã        | {result['wall_thickness']} | –º–º |
| –í–µ—Å 1 –±–ª–æ–∫–∞          | {result['block_weight']} | –∫–≥ |
| –û–±—â–∏–π –≤–µ—Å –∫–µ—Ä–∞–º–æ–±–ª–æ–∫–æ–≤ | {result['total_weight']} | –∫–≥ |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–µ—Ä–∞–º–æ–±–ª–æ–∫–æ–≤ –≤ –∫—É–±–µ | {result['blocks_per_cube']} | —à—Ç/–º¬≥ |
| –ö–æ–ª-–≤–æ —Ä–∞—Å—Ç–≤–æ—Ä–∞ –Ω–∞ –≤—Å—é –∫–ª–∞–¥–∫—É | {result['mortar_volume']} | –º¬≥ |
| –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å —Ä–∞—Å—Ç–≤–æ—Ä–∞ | {result['mortar_weight']} | –∫–≥ |
| –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω—ã | {result['optimal_height']} | —Å–º |
| –ö–æ–ª-–≤–æ —Ä—è–¥–æ–≤ –±–ª–æ–∫–æ–≤ —Å —É—á–µ—Ç–æ–º —à–≤–æ–≤ | {result['rows_count']} | —Ä—è–¥–æ–≤ |
| –ö–æ–ª-–≤–æ –∫–ª–∞–¥–æ—á–Ω–æ–π —Å–µ—Ç–∫–∏ | {result['mesh_length']} | –º–µ—Ç—Ä–æ–≤ |
| –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å –≥–æ—Ç–æ–≤—ã—Ö —Å—Ç–µ–Ω | {result['total_wall_weight']} | –∫–≥ |
| –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –æ—Ç —Å—Ç–µ–Ω | {result['foundation_load']} | –∫–≥/—Å–º¬≤ |

üìè –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞:
‚Ä¢ –†–∞–∑–º–µ—Ä—ã: {result['block_dimensions']}
‚Ä¢ –í–µ—Å 1 –±–ª–æ–∫–∞: {result['block_weight']} –∫–≥

"""

def format_general_result(result: dict) -> str:
    """–û–±—â–µ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞"""
    if "error" in result:
        return f"‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: {result['error']}"
    
    material_type = result.get('material_type', '–º–∞—Ç–µ—Ä–∏–∞–ª–∞')
    
    return f"""
üìä –†–ï–ó–£–õ–¨–¢–ê–¢ –†–ê–°–ß–ï–¢–ê {material_type.upper()}

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
‚Ä¢ –ü–µ—Ä–∏–º–µ—Ç—Ä: {result.get('perimeter', 0)} –º
‚Ä¢ –ü–ª–æ—â–∞–¥—å –∫–ª–∞–¥–∫–∏: {result.get('wall_area', 0)} –º¬≤
‚Ä¢ –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω—ã: {result.get('wall_thickness', 0)} –º–º
‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {result.get('bricks_needed', result.get('blocks_needed', 0))} —à—Ç
‚Ä¢ –û–±—â–∏–π –≤–µ—Å: {result.get('total_weight', 0)} –∫–≥
‚Ä¢ –û–±—ä–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª–∞: {result.get('total_volume', 0)} m¬≥

üí° –î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞.
"""

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
def get_main_keyboard(user_id: int):
    web_app_url = f"https://yandex.ru/maps/?ll=44.060119%2C56.221272&mode=poi&poi%5Bpoint%5D=44.057594%2C56.221962&poi%5Buri%5D=ymapsbm1%3A%2F%2Forg%3Foid%3D195684583654&source=serp_navig&z=16.34"
    calculator_web_app_url = "https://stroy-calc.ru/"  # –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –†–ï–ê–õ–¨–ù–´–ô URL
    
    keyboard = [
        # –ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (2 –≤ —Ä—è–¥) - –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞
        [InlineKeyboardButton(text="üìä –ü—Ä–∞–π—Å-–ª–∏—Å—Ç", callback_data="price"),
         InlineKeyboardButton(text="üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤ –±–æ—Ç–µ", callback_data="calculation")],
        
        # –í–µ–±-—Ñ—É–Ω–∫—Ü–∏–∏ (2 –≤ —Ä—è–¥) - –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
        [InlineKeyboardButton(text="üåê –í–µ–±-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä", web_app=WebAppInfo(url=calculator_web_app_url)),
         InlineKeyboardButton(text="üó∫Ô∏è –ù–∞—à –º–∞–≥–∞–∑–∏–Ω", web_app=WebAppInfo(url=web_app_url))],
    ]
    
    # –°–ª—É–∂–µ–±–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä—è–¥—ã –¥–ª—è –ª—É—á—à–µ–π –≤–∏–∑—É–∞–ª—å–Ω–æ–π –∏–µ—Ä–∞—Ä—Ö–∏–∏)
    additional_buttons = []
    
    if is_staff(user_id):
        additional_buttons.append([InlineKeyboardButton(text="üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏", callback_data="products_panel")])
    
    if is_admin(user_id):
        additional_buttons.append([InlineKeyboardButton(text="‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_panel")])
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ –∫–æ–Ω–µ—Ü
    keyboard.extend(additional_buttons)
    
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def get_price_categories_keyboard():
    categories = get_product_categories()
    keyboard = []
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ 2 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —ç–º–æ–¥–∑–∏
    for i in range(0, len(categories), 2):
        row = []
        if i < len(categories):
            row.append(InlineKeyboardButton(
                text=f"{categories[i].capitalize()}", 
                callback_data=f"category_{categories[i]}"
            ))
        if i + 1 < len(categories):
            row.append(InlineKeyboardButton(
                text=f"{categories[i+1].capitalize()}", 
                callback_data=f"category_{categories[i+1]}"
            ))
        if row:
            keyboard.append(row)
    
    keyboard.append([InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_main")])
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def get_price_pagination_keyboard(category: str, page: int, total_pages: int):
    buttons = []
    
    if total_pages > 1:
        nav_buttons = []
        if page > 1:
            nav_buttons.append(InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data=f"page_{category}_{page-1}"))
        
        nav_buttons.append(InlineKeyboardButton(text=f"{page}/{total_pages}", callback_data="current"))
        
        if page < total_pages:
            nav_buttons.append(InlineKeyboardButton(text="–í–ø–µ—Ä—ë–¥ ‚ñ∂Ô∏è", callback_data=f"page_{category}_{page+1}"))
        
        buttons.append(nav_buttons)
    
    buttons.append([InlineKeyboardButton(text="üìÇ –ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º", callback_data="back_to_categories")])
    buttons.append([InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_main")])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_calculation_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üß± –ö–∏—Ä–ø–∏—á", callback_data="calc_bricks"),
         InlineKeyboardButton(text="üèóÔ∏è –ì–∞–∑–æ–±–ª–æ–∫–∏", callback_data="calc_gas_blocks")],
        [InlineKeyboardButton(text="üß± –ü–µ–Ω–æ–±–ª–æ–∫–∏", callback_data="calc_foam_blocks"),
         InlineKeyboardButton(text="üèóÔ∏è –ö–µ—Ä–∞–º–æ–±–ª–æ–∫–∏", callback_data="calc_ceramic_blocks")],
        [InlineKeyboardButton(text="üß± –°—Ç–µ–Ω–æ–≤—ã–µ –±–ª–æ–∫–∏", callback_data="calc_wall_blocks")],
        [InlineKeyboardButton(text="üéØ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç", callback_data="advanced_calculation")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_main")]
    ])

def get_brick_type_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üß± –û–¥–∏–Ω–∞—Ä–Ω—ã–π", callback_data="brick_single"),
         InlineKeyboardButton(text="üß± –ü–æ–ª—É—Ç–æ—Ä–Ω—ã–π", callback_data="brick_one_half")],
        [InlineKeyboardButton(text="üß± –î–≤–æ–π–Ω—ã–π", callback_data="brick_double")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_calc")]
    ])

def get_products_panel_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä", callback_data="admin_add_product")],
        [InlineKeyboardButton(text="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä", callback_data="admin_edit_product")],
        [InlineKeyboardButton(text="üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä", callback_data="admin_delete_product")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_main")]
    ])

def get_admin_panel_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏", callback_data="manage_staff"),
         InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="detailed_stats")],
        [InlineKeyboardButton(text="üìù –ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞", callback_data="audit_log")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_main")]
    ])

def get_staff_management_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", callback_data="add_staff"),
         InlineKeyboardButton(text="üë• –°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤", callback_data="list_staff")],
        [InlineKeyboardButton(text="üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", callback_data="remove_staff")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")]
    ])

def get_admin_products_keyboard(page: int = 1, per_page: int = 8):
    products = get_all_products()
    total_pages = (len(products) + per_page - 1) // per_page
    
    start_idx = (page - 1) * per_page
    end_idx = start_idx + per_page
    paginated_products = products[start_idx:end_idx]
    
    keyboard = []
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ 2 –≤ —Ä—è–¥
    for i in range(0, len(paginated_products), 2):
        row = []
        if i < len(paginated_products):
            product = paginated_products[i]
            row.append(InlineKeyboardButton(
                text=f"üì¶ {product[1][:15]}...", 
                callback_data=f"admin_product_{product[0]}"
            ))
        if i + 1 < len(paginated_products):
            product = paginated_products[i+1]
            row.append(InlineKeyboardButton(
                text=f"üì¶ {product[1][:15]}...", 
                callback_data=f"admin_product_{product[0]}"
            ))
        if row:
            keyboard.append(row)
    
    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    if total_pages > 1:
        nav_buttons = []
        if page > 1:
            nav_buttons.append(InlineKeyboardButton(text="‚¨ÖÔ∏è", callback_data=f"products_page_{page-1}"))
        
        nav_buttons.append(InlineKeyboardButton(text=f"{page}/{total_pages}", callback_data="current"))
        
        if page < total_pages:
            nav_buttons.append(InlineKeyboardButton(text="‚û°Ô∏è", callback_data=f"products_page_{page+1}"))
        
        keyboard.append(nav_buttons)
    
    keyboard.append([InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="products_panel")])
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def get_edit_product_keyboard(product_id: int):
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úèÔ∏è –ù–∞–∑–≤–∞–Ω–∏–µ", callback_data=f"edit_name_{product_id}")],
        [InlineKeyboardButton(text="üí∞ –¶–µ–Ω–∞", callback_data=f"edit_price_{product_id}")],
        [InlineKeyboardButton(text="üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", callback_data=f"edit_quantity_{product_id}")],
        [InlineKeyboardButton(text="üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è", callback_data=f"edit_category_{product_id}")],
        [InlineKeyboardButton(text="üìè –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è", callback_data=f"edit_unit_{product_id}")],
        [InlineKeyboardButton(text="üìù –û–ø–∏—Å–∞–Ω–∏–µ", callback_data=f"edit_description_{product_id}")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Ç–æ–≤–∞—Ä–∞–º", callback_data="admin_edit_product_1")]
    ])

def get_staff_list_keyboard(page: int = 1, per_page: int = 8):
    staff_list = get_all_staff()
    total_pages = (len(staff_list) + per_page - 1) // per_page
    
    start_idx = (page - 1) * per_page
    end_idx = start_idx + per_page
    paginated_staff = staff_list[start_idx:end_idx]
    
    keyboard = []
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ 2 –≤ —Ä—è–¥
    for i in range(0, len(paginated_staff), 2):
        row = []
        if i < len(paginated_staff):
            staff = paginated_staff[i]
            display_name = staff[3] or staff[2] or f"ID:{staff[1]}"
            row.append(InlineKeyboardButton(
                text=f"üë§ {display_name[:12]}", 
                callback_data=f"staff_info_{staff[1]}"
            ))
        if i + 1 < len(paginated_staff):
            staff = paginated_staff[i+1]
            display_name = staff[3] or staff[2] or f"ID:{staff[1]}"
            row.append(InlineKeyboardButton(
                text=f"üë§ {display_name[:12]}", 
                callback_data=f"staff_info_{staff[1]}"
            ))
        if row:
            keyboard.append(row)
    
    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    if total_pages > 1:
        nav_buttons = []
        if page > 1:
            nav_buttons.append(InlineKeyboardButton(text="‚¨ÖÔ∏è", callback_data=f"staff_page_{page-1}"))
        
        nav_buttons.append(InlineKeyboardButton(text=f"{page}/{total_pages}", callback_data="current"))
        
        if page < total_pages:
            nav_buttons.append(InlineKeyboardButton(text="‚û°Ô∏è", callback_data=f"staff_page_{page+1}"))
        
        keyboard.append(nav_buttons)
    
    keyboard.append([InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="manage_staff")])
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def get_remove_staff_keyboard(page: int = 1, per_page: int = 8):
    staff_list = get_all_staff()
    total_pages = (len(staff_list) + per_page - 1) // per_page
    
    start_idx = (page - 1) * per_page
    end_idx = start_idx + per_page
    paginated_staff = staff_list[start_idx:end_idx]
    
    keyboard = []
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ 2 –≤ —Ä—è–¥
    for i in range(0, len(paginated_staff), 2):
        row = []
        if i < len(paginated_staff):
            staff = paginated_staff[i]
            display_name = staff[3] or staff[2] or f"ID:{staff[1]}"
            row.append(InlineKeyboardButton(
                text=f"üóëÔ∏è {display_name[:10]}", 
                callback_data=f"remove_staff_{staff[1]}"
            ))
        if i + 1 < len(paginated_staff):
            staff = paginated_staff[i+1]
            display_name = staff[3] or staff[2] or f"ID:{staff[1]}"
            row.append(InlineKeyboardButton(
                text=f"üóëÔ∏è {display_name[:10]}", 
                callback_data=f"remove_staff_{staff[1]}"
            ))
        if row:
            keyboard.append(row)
    
    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    if total_pages > 1:
        nav_buttons = []
        if page > 1:
            nav_buttons.append(InlineKeyboardButton(text="‚¨ÖÔ∏è", callback_data=f"remove_staff_page_{page-1}"))
        
        nav_buttons.append(InlineKeyboardButton(text=f"{page}/{total_pages}", callback_data="current"))
        
        if page < total_pages:
            nav_buttons.append(InlineKeyboardButton(text="‚û°Ô∏è", callback_data=f"remove_staff_page_{page+1}"))
        
        keyboard.append(nav_buttons)
    
    keyboard.append([InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="manage_staff")])
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def get_audit_log_keyboard(page: int = 1, per_page: int = 5):
    audit_log = get_audit_log(100)
    total_pages = (len(audit_log) + per_page - 1) // per_page
    
    keyboard = []
    
    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    if total_pages > 1:
        nav_buttons = []
        if page > 1:
            nav_buttons.append(InlineKeyboardButton(text="‚¨ÖÔ∏è", callback_data=f"audit_page_{page-1}"))
        
        nav_buttons.append(InlineKeyboardButton(text=f"{page}/{total_pages}", callback_data="current"))
        
        if page < total_pages:
            nav_buttons.append(InlineKeyboardButton(text="‚û°Ô∏è", callback_data=f"audit_page_{page+1}"))
        
        keyboard.append(nav_buttons)
    
    keyboard.append([InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="audit_log_1")])
    keyboard.append([InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")])
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def get_wall_thickness_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="0.5 (–ø–æ–ª–æ–≤–∏–Ω–∞)", callback_data="thickness_0.5"),
         InlineKeyboardButton(text="1.0 (–≤ –º–∞—Ç–µ—Ä–∏–∞–ª)", callback_data="thickness_1.0")],
        [InlineKeyboardButton(text="1.5 (–ø–æ–ª—Ç–æ—Ä–∞)", callback_data="thickness_1.5"),
         InlineKeyboardButton(text="2.0 (–¥–≤–∞)", callback_data="thickness_2.0")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_calc")]
    ])

def get_mortar_thickness_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="2 –º–º (–∫–ª–µ–π)", callback_data="mortar_2"),
         InlineKeyboardButton(text="3 –º–º (–ø–µ–Ω–∞)", callback_data="mortar_3")],
        [InlineKeyboardButton(text="10 –º–º (—Ä–∞—Å—Ç–≤–æ—Ä)", callback_data="mortar_10"),
         InlineKeyboardButton(text="15 –º–º (—Ä–∞—Å—Ç–≤–æ—Ä)", callback_data="mortar_15")],
        [InlineKeyboardButton(text="20 –º–º (—Ä–∞—Å—Ç–≤–æ—Ä)", callback_data="mortar_20")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_calc")]
    ])

def get_mesh_frequency_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="–ö–∞–∂–¥—ã–π —Ä—è–¥", callback_data="mesh_1"),
         InlineKeyboardButton(text="–ß–µ—Ä–µ–∑ —Ä—è–¥", callback_data="mesh_2")],
        [InlineKeyboardButton(text="–ß–µ—Ä–µ–∑ 2 —Ä—è–¥–∞", callback_data="mesh_3"),
         InlineKeyboardButton(text="–ß–µ—Ä–µ–∑ 3 —Ä—è–¥–∞", callback_data="mesh_4")],
        [InlineKeyboardButton(text="–ß–µ—Ä–µ–∑ 4 —Ä—è–¥–∞", callback_data="mesh_5"),
         InlineKeyboardButton(text="–ù–µ –Ω—É–∂–Ω–∞", callback_data="mesh_0")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_calc")]
    ])

def get_density_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="D250", callback_data="density_250"),
         InlineKeyboardButton(text="D300", callback_data="density_300")],
        [InlineKeyboardButton(text="D350", callback_data="density_350"),
         InlineKeyboardButton(text="D400", callback_data="density_400")],
        [InlineKeyboardButton(text="D500", callback_data="density_500"),
         InlineKeyboardButton(text="D600", callback_data="density_600")],
        [InlineKeyboardButton(text="D700", callback_data="density_700"),
         InlineKeyboardButton(text="D800", callback_data="density_800")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_calc")]
    ])

def get_confirmation_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å", callback_data="confirm_calculation")],
        [InlineKeyboardButton(text="‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã", callback_data="edit_parameters")],
        [InlineKeyboardButton(text="üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ", callback_data="restart_calculation")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
    ])

def get_category_keyboard():
    categories = get_product_categories()
    keyboard = []
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ 2 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥
    for i in range(0, len(categories), 2):
        row = []
        if i < len(categories):
            row.append(InlineKeyboardButton(
                text=f"üìÇ {categories[i].capitalize()}", 
                callback_data=f"select_category_{categories[i]}"
            ))
        if i + 1 < len(categories):
            row.append(InlineKeyboardButton(
                text=f"üìÇ {categories[i+1].capitalize()}", 
                callback_data=f"select_category_{categories[i+1]}"
            ))
        if row:
            keyboard.append(row)
    
    keyboard.append([InlineKeyboardButton(text="‚ûï –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è", callback_data="new_category")])
    keyboard.append([InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="cancel_add_product")])
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def get_simple_calculation_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üß± –ö–∏—Ä–ø–∏—á", callback_data="simple_calc_bricks"),
         InlineKeyboardButton(text="üèóÔ∏è –ì–∞–∑–æ–±–ª–æ–∫–∏", callback_data="simple_calc_gas_blocks")],
        [InlineKeyboardButton(text="üß± –ü–µ–Ω–æ–±–ª–æ–∫–∏", callback_data="simple_calc_foam_blocks"),
         InlineKeyboardButton(text="üèóÔ∏è –ö–µ—Ä–∞–º–æ–±–ª–æ–∫–∏", callback_data="simple_calc_ceramic_blocks")],
        [InlineKeyboardButton(text="üß± –°—Ç–µ–Ω–æ–≤—ã–µ –±–ª–æ–∫–∏", callback_data="calc_wall_blocks")],
        [InlineKeyboardButton(text="üéØ –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç", callback_data="detailed_calculation")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
    ])

def get_detailed_calculation_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üß± –ö–∏—Ä–ø–∏—á", callback_data="calc_bricks"),
         InlineKeyboardButton(text="üèóÔ∏è –ì–∞–∑–æ–±–ª–æ–∫–∏", callback_data="calc_gas_blocks")],
        [InlineKeyboardButton(text="üß± –ü–µ–Ω–æ–±–ª–æ–∫–∏", callback_data="calc_foam_blocks"),
         InlineKeyboardButton(text="üèóÔ∏è –ö–µ—Ä–∞–º–æ–±–ª–æ–∫–∏", callback_data="calc_ceramic_blocks")],
        [InlineKeyboardButton(text="üß± –°—Ç–µ–Ω–æ–≤—ã–µ –±–ª–æ–∫–∏", callback_data="calc_wall_blocks")],
        [InlineKeyboardButton(text="‚ö° –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç", callback_data="simple_calculation")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
    ])

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
async def show_products_page(callback: CallbackQuery, category: str, page: int):
    products, total = get_products_by_category(category, page)
    total_pages = max(1, (total + 4) // 5)
    
    if page < 1:
        page = 1
    elif page > total_pages:
        page = total_pages
    
    # –ë–æ–ª–µ–µ —á–∏—Å—Ç—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
    products_text = f"üì¶ **{category.upper()}** - –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page}/{total_pages}\n\n"
    
    for i, product in enumerate(products, 1):
        products_text += f"**{i}. {product[1]}**\n"
        products_text += f"   ‚Ä¢ –¶–µ–Ω–∞: {product[2]:.2f} —Ä—É–±./{product[5]}\n"
        products_text += f"   ‚Ä¢ –í –Ω–∞–ª–∏—á–∏–∏: {product[3]} {product[5]}\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å –∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
        if product[6] and len(product[6]) < 100:
            products_text += f"   ‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ: {product[6]}\n"
        
        products_text += "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
    
    await callback.message.edit_text(products_text, parse_mode="Markdown", reply_markup=get_price_pagination_keyboard(category, page, total_pages))

async def ask_perimeter(message: Message, state: FSMContext):
    await message.answer("""
üè† <b>–®–∞–≥ 6: –ü–µ—Ä–∏–º–µ—Ç—Ä —Å—Ç—Ä–æ–µ–Ω–∏—è</b>

–í–≤–µ–¥–∏—Ç–µ –æ–±—â—É—é –¥–ª–∏–Ω—É –≤—Å–µ—Ö —Å—Ç–µ–Ω –≤ –º–µ—Ç—Ä–∞—Ö:

–ù–∞–ø—Ä–∏–º–µ—Ä:
‚Ä¢ –î–æ–º 7√ó8 –º: –ø–µ—Ä–∏–º–µ—Ç—Ä = 7+7+8+8 = 30 –º
‚Ä¢ –ì–∞—Ä–∞–∂ 6√ó4 –º: –ø–µ—Ä–∏–º–µ—Ç—Ä = 6+6+4+4 = 20 –º
‚Ä¢ –ë–∞–Ω—è 3√ó4 –º: –ø–µ—Ä–∏–º–µ—Ç—Ä = 3+3+4+4 = 14 –º

–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–∏–º–µ—Ç—Ä –≤ –º–µ—Ç—Ä–∞—Ö:
""", parse_mode="HTML")
    await state.set_state(CalculationState.entering_perimeter)

async def ask_about_gables(message: Message, state: FSMContext):
    await message.answer("""
üî∫ <b>–®–∞–≥ 10: –§—Ä–æ–Ω—Ç–æ–Ω—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</b>

–ï—Å—Ç—å –ª–∏ –≤ –≤–∞—à–µ–º —Å—Ç—Ä–æ–µ–Ω–∏–∏ —Ñ—Ä–æ–Ω—Ç–æ–Ω—ã (—Ç—Ä–µ—É–≥–æ–ª—å–Ω—ã–µ —Å—Ç–µ–Ω—ã –ø–æ–¥ –∫—Ä—ã—à–µ–π)?

–§—Ä–æ–Ω—Ç–æ–Ω—ã —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Ä–∞—Å—Ö–æ–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∏ –¥–æ–ª–∂–Ω—ã —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –≤ —Ä–∞—Å—á–µ—Ç–µ.
""", parse_mode="HTML", reply_markup=InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –î–∞, –µ—Å—Ç—å —Ñ—Ä–æ–Ω—Ç–æ–Ω—ã", callback_data="gables_yes")],
        [InlineKeyboardButton(text="‚ùå –ù–µ—Ç —Ñ—Ä–æ–Ω—Ç–æ–Ω–æ–≤", callback_data="gables_no")]
    ]))
    await state.set_state(CalculationState.asking_gables)

async def ask_about_openings(message: Message, state: FSMContext):
    await message.answer("""
üö™ü™ü <b>–®–∞–≥ 11: –û–∫–Ω–∞ –∏ –¥–≤–µ—Ä–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</b>

–ù—É–∂–Ω–æ –ª–∏ –≤—ã—á–µ—Å—Ç—å –∏–∑ —Ä–∞—Å—á–µ—Ç–∞ –ø–ª–æ—â–∞–¥—å –æ–∫–æ–Ω –∏ –¥–≤–µ—Ä–µ–π?

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Ç–æ—á–Ω–µ–µ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞.
""", parse_mode="HTML", reply_markup=InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –î–∞, —É—á–µ—Å—Ç—å –ø—Ä–æ–µ–º—ã", callback_data="openings_yes")],
        [InlineKeyboardButton(text="‚ùå –ù–µ—Ç, –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å", callback_data="openings_no")]
    ]))
    await state.set_state(CalculationState.asking_openings)

async def ask_about_mesh(message: Message, state: FSMContext):
    await message.answer("""
üï∏Ô∏è <b>–®–∞–≥ 12: –ö–ª–∞–¥–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</b>

–ù—É–∂–Ω–∞ –ª–∏ –∫–ª–∞–¥–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞ –¥–ª—è –∞—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è?

–°–µ—Ç–∫–∞ –ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–æ—á–Ω–æ—Å—Ç—å –∫–ª–∞–¥–∫–∏ –∏ –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
‚Ä¢ –í –∫–∞–∂–¥–æ–º 3-4 —Ä—è–¥—É –¥–ª—è –∫–∏—Ä–ø–∏—á–∞
‚Ä¢ –í –∫–∞–∂–¥–æ–º 2-3 —Ä—è–¥—É –¥–ª—è –±–ª–æ–∫–æ–≤
‚Ä¢ –í —Å–µ–π—Å–º–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞–π–æ–Ω–∞—Ö
""", parse_mode="HTML", reply_markup=InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –î–∞, –Ω—É–∂–Ω–∞ —Å–µ—Ç–∫–∞", callback_data="mesh_yes")],
        [InlineKeyboardButton(text="‚ùå –ù–µ—Ç, –Ω–µ –Ω—É–∂–Ω–∞", callback_data="mesh_no")]
    ]))
    await state.set_state(CalculationState.asking_mesh)

async def ask_about_price(message: Message, state: FSMContext):
    data = await state.get_data()
    material_type = data.get('material_type')
    
    price_units = {
        'bricks': '–∑–∞ —à—Ç—É–∫—É',
        'ceramic_blocks': '–∑–∞ —à—Ç—É–∫—É',
        'wall_blocks': '–∑–∞ —à—Ç—É–∫—É',
        'foam_blocks': '–∑–∞ –∫—É–±–æ–º–µ—Ç—Ä',
        'gas_blocks': '–∑–∞ –∫—É–±–æ–º–µ—Ç—Ä'
    }
    
    unit = price_units.get(material_type, '–∑–∞ –µ–¥–∏–Ω–∏—Ü—É')
    
    await message.answer(f"""
üí∞ <b>–®–∞–≥ 13: –°—Ç–æ–∏–º–æ—Å—Ç—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</b>

–•–æ—Ç–∏—Ç–µ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞?

–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É {unit} –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ "-" –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞.
""", parse_mode="HTML", reply_markup=InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –£–∫–∞–∑–∞—Ç—å —Ü–µ–Ω—É", callback_data="price_yes")],
        [InlineKeyboardButton(text="‚ùå –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="price_no")]
    ]))
    await state.set_state(CalculationState.asking_price)

async def show_calculation_summary(message: Message, state: FSMContext):
    data = await state.get_data()
    params = data.get('calculation_params', {})
    material_type = data.get('material_type')
    
    material_names = {
        'bricks': '–ö–∏—Ä–ø–∏—á',
        'wall_blocks': '–°—Ç–µ–Ω–æ–≤—ã–µ –±–ª–æ–∫–∏',
        'foam_blocks': '–ü–µ–Ω–æ–±–ª–æ–∫–∏', 
        'gas_blocks': '–ì–∞–∑–æ–±–µ—Ç–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏',
        'ceramic_blocks': '–ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏'
    }
    
    material_name = material_names.get(material_type, material_type)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–≤–æ–¥–∫—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    summary = f"""
üìã –°–í–û–î–ö–ê –ü–ê–†–ê–ú–ï–¢–†–û–í

üß± –ú–∞—Ç–µ—Ä–∏–∞–ª: {material_name}

üìè –†–∞–∑–º–µ—Ä—ã:
"""
    
    if material_type == 'bricks':
        summary += f"‚Ä¢ {params['brick_length']}√ó{params['brick_width']}√ó{params['brick_height']} –º–º\n"
        summary += f"‚Ä¢ –í–µ—Å: {params.get('brick_weight', '–Ω–µ —É–∫–∞–∑–∞–Ω')} –∫–≥\n"
        if params.get('brick_pulsatility', 0) > 0:
            summary += f"‚Ä¢ –ü—É—Å—Ç–æ—Ç–Ω–æ—Å—Ç—å: {params['brick_pulsatility']}%\n"
    else:
        summary += f"‚Ä¢ {params['block_length']}√ó{params['block_width']}√ó{params['block_height']} –º–º\n"
        if 'density' in params:
            summary += f"‚Ä¢ –ü–ª–æ—Ç–Ω–æ—Å—Ç—å: D{params['density']} –∫–≥/–º¬≥\n"
    
    summary += f"""

üè† –°—Ç—Ä–æ–µ–Ω–∏–µ:
‚Ä¢ –ü–µ—Ä–∏–º–µ—Ç—Ä: {params['perimeter']} –º
‚Ä¢ –í—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω: {params['wall_height']} —Å–º
‚Ä¢ –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω: {params['wall_thickness']}
‚Ä¢ –¢–æ–ª—â–∏–Ω–∞ —à–≤–∞: {params['mortar_thickness']} –º–º

"""
    
    # –§—Ä–æ–Ω—Ç–æ–Ω—ã
    if params.get('gables'):
        summary += f"üî∫ <b>–§—Ä–æ–Ω—Ç–æ–Ω—ã:</b> {len(params['gables'])} —à—Ç.\n"
        for i, gable in enumerate(params['gables'], 1):
            summary += f"‚Ä¢ –§—Ä–æ–Ω—Ç–æ–Ω {i}: {gable['width']}√ó{gable['height']} —Å–º\n"
        summary += "\n"
    
    # –ü—Ä–æ–µ–º—ã
    if params.get('openings'):
        windows = [o for o in params['openings'] if o['type'] == 'window']
        doors = [o for o in params['openings'] if o['type'] == 'door']
        
        if windows:
            summary += f"ü™ü <b>–û–∫–Ω–∞:</b> {len(windows)} —Ç–∏–ø–æ–≤\n"
            for window in windows:
                summary += f"‚Ä¢ {window['count']} —à—Ç. {window['width']}√ó{window['height']} —Å–º\n"
        
        if doors:
            summary += f"üö™ <b>–î–≤–µ—Ä–∏:</b> {len(doors)} —Ç–∏–ø–æ–≤\n"
            for door in doors:
                summary += f"‚Ä¢ {door['count']} —à—Ç. {door['width']}√ó{door['height']} —Å–º\n"
        summary += "\n"
    
    # –°–µ—Ç–∫–∞
    if params.get('mesh_frequency', 0) > 0:
        frequency_names = {1: "–∫–∞–∂–¥—ã–π —Ä—è–¥", 2: "—á–µ—Ä–µ–∑ —Ä—è–¥", 3: "—á–µ—Ä–µ–∑ 2 —Ä—è–¥–∞", 4: "—á–µ—Ä–µ–∑ 3 —Ä—è–¥–∞", 5: "—á–µ—Ä–µ–∑ 4 —Ä—è–¥–∞"}
        summary += f"üï∏Ô∏è <b>–ö–ª–∞–¥–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞:</b> {frequency_names[params['mesh_frequency']]}\n\n"
    
    # –¶–µ–Ω–∞
    if params.get('price', 0) > 0 or params.get('price_per_cube', 0) > 0:
        price = params.get('price', params.get('price_per_cube', 0))
        unit = "—Ä—É–±/—à—Ç" if material_type in ['bricks', 'ceramic_blocks', 'wall_blocks'] else "—Ä—É–±/–º¬≥"
        summary += f"üí∞ **–¶–µ–Ω–∞:** {price} {unit}\n\n"
    
    summary += "–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É–∫–∞–∑–∞–Ω—ã –≤–µ—Ä–Ω–æ?"
    
    await message.answer(summary, reply_markup=get_confirmation_keyboard())
    await state.set_state(CalculationState.confirming_calculation)

async def show_audit_log_page(callback: CallbackQuery, page: int = None):
    if is_admin(callback.from_user.id):
        if page is None:
            page = int(callback.data.split("_")[2])
        
        audit_log = get_audit_log()
        total_pages = (len(audit_log) + 4) // 5
        
        if page < 1:
            page = 1
        elif page > total_pages:
            page = total_pages
        
        start_idx = (page - 1) * 5
        end_idx = start_idx + 5
        paginated_log = audit_log[start_idx:end_idx]
        
        log_text = "üìù –ê–£–î–ò–¢ –î–ï–ô–°–¢–í–ò–ô\n\n"
        
        for log in paginated_log:
            log_text += f"‚è∞ {log[5]}\n"
            log_text += f"üë§ {log[2] or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} (ID: {log[1]})\n"
            log_text += f"üìã {log[3]}\n"
            if log[4]:
                log_text += f"üìÑ {log[4]}\n"
            log_text += "‚îÄ" * 30 + "\n"
        
        log_text += f"\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page}/{total_pages}"
        
        await callback.message.edit_text(log_text, reply_markup=get_audit_log_keyboard(page))
        log_audit(callback.from_user.id, callback.from_user.username, "view_audit", f"–ü—Ä–æ—Å–º–æ—Ç—Ä –∞—É–¥–∏—Ç–∞, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ {page}")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
@dp.message(CommandStart())
async def cmd_start(message: Message):
    welcome_text = """
üèóÔ∏è <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –°—Ç—Ä–æ–π–ì—Ä–∞–¥–™-–ù–ù!</b>

–Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:

<b>üìä –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</b>
‚Ä¢ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç - –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –∏ –Ω–∞–ª–∏—á–∏–µ
‚Ä¢ –†–∞—Å—á–µ—Ç –≤ –±–æ—Ç–µ - –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤ –±–æ—Ç–µ (—É–¥–æ–±–Ω–µ–µ –Ω–∞ —Å–∞–π—Ç–µ)

<b>üåê –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>
‚Ä¢ –í–µ–±-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
‚Ä¢ –ù–∞—à –º–∞–≥–∞–∑–∏–Ω - —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ
"""
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
    if is_staff(message.from_user.id):
        welcome_text += "\n<b>üì¶ –î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:</b>\n‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏"
    
    if is_admin(message.from_user.id):
        welcome_text += "\n<b>‚öôÔ∏è –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:</b>\n‚Ä¢ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã"
    
    welcome_text += "\n\nüëá <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:</b>"
    
    await message.answer(welcome_text, parse_mode="HTML", reply_markup=get_main_keyboard(message.from_user.id))
    log_audit(message.from_user.id, message.from_user.username, "start", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")

@dp.message(Command("–ø—Ä–∞–π—Å"))
async def cmd_price(message: Message):
    await show_categories(message)
    log_audit(message.from_user.id, message.from_user.username, "price_command", "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∞–π—Å–∞")

@dp.message(Command("—Ä–∞—Å—Å—á–µ—Ç"))
async def cmd_calculation(message: Message):
    await show_calculation_options(message)
    log_audit(message.from_user.id, message.from_user.username, "calculation_command", "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞—Å—á–µ—Ç–∞")


@dp.message(Command("add_staff"))
async def cmd_add_staff(message: Message):
    if is_admin(message.from_user.id):
        try:
            user_id = int(message.text.split()[1])
            username = message.from_user.username
            full_name = f"{message.from_user.first_name} {message.from_user.last_name or ''}".strip()
            
            if add_staff(user_id, username, full_name, message.from_user.id):
                await message.answer("‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!")
                log_audit(message.from_user.id, message.from_user.username, "add_staff", f"–î–æ–±–∞–≤–ª–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ ID: {user_id}")
            else:
                await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)")
        except (IndexError, ValueError):
            await message.answer("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /add_staff <ID_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è>")
    else:
        await message.answer("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback-–∑–∞–ø—Ä–æ—Å–æ–≤
@dp.callback_query(F.data == "back_to_main")
async def back_to_main(callback: CallbackQuery):
    welcome_text = """
üèóÔ∏è <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –°—Ç—Ä–æ–π–ì—Ä–∞–¥–™-–ù–ù!</b>

–Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:

<b>üìä –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</b>
‚Ä¢ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç - –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –∏ –Ω–∞–ª–∏—á–∏–µ
‚Ä¢ –†–∞—Å—á–µ—Ç –≤ –±–æ—Ç–µ - –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤ –±–æ—Ç–µ (—É–¥–æ–±–Ω–µ–µ –Ω–∞ —Å–∞–π—Ç–µ)

<b>üåê –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>
‚Ä¢ –í–µ–±-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
‚Ä¢ –ù–∞—à –º–∞–≥–∞–∑–∏–Ω - —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ
"""
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
    if is_staff(callback.from_user.id):
        welcome_text += "\n<b>üì¶ –î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:</b>\n‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏"
    
    if is_admin(callback.from_user.id):
        welcome_text += "\n<b>‚öôÔ∏è –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:</b>\n‚Ä¢ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã"
    
    welcome_text += "\n\nüëá <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:</b>"
    
    await callback.message.edit_text(welcome_text, parse_mode="HTML", reply_markup=get_main_keyboard(callback.from_user.id))
    await callback.answer()

@dp.callback_query(F.data == "price")
async def show_categories(callback: CallbackQuery):
    categories_text = "**–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–æ–≤:**"
    await callback.message.edit_text(categories_text, parse_mode="Markdown", reply_markup=get_price_categories_keyboard())
    await callback.answer()

@dp.callback_query(F.data.startswith("category_"))
async def show_category_products(callback: CallbackQuery):
    category = callback.data.split("_")[1]
    await show_products_page(callback, category, 1)
    await callback.answer()
    log_audit(callback.from_user.id, callback.from_user.username, "view_category", f"–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {category}")

@dp.callback_query(F.data.startswith("page_"))
async def handle_pagination(callback: CallbackQuery):
    data_parts = callback.data.split("_")
    category = data_parts[1]
    page = int(data_parts[2])
    
    await show_products_page(callback, category, page)
    await callback.answer()

@dp.callback_query(F.data == "back_to_categories")
async def back_to_categories(callback: CallbackQuery):
    categories_text = "üìã –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–æ–≤:"
    await callback.message.edit_text(categories_text, reply_markup=get_price_categories_keyboard())
    await callback.answer()

@dp.callback_query(F.data == "calculation")
async def show_calculation_options(callback: CallbackQuery):
    calculation_text = """
üßÆ –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –°–¢–†–û–ò–¢–ï–õ–¨–ù–´–• –ú–ê–¢–ï–†–ò–ê–õ–û–í

–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞—Å—á–µ—Ç–∞:

üéØ <b>–î–ï–¢–ê–õ–¨–ù–´–ô –†–ê–°–ß–ï–¢</b>:

üìè <b>–¢–æ—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞:</b>
‚Ä¢ –õ—é–±—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–∏—Ä–ø–∏—á–∞/–±–ª–æ–∫–æ–≤ (–Ω–µ —Ç–æ–ª—å–∫–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ)
‚Ä¢ –£—á–µ—Ç –≤–µ—Å–∞ –∏ –ø—É—Å—Ç–æ—Ç–Ω–æ—Å—Ç–∏ –∫–∏—Ä–ø–∏—á–∞
‚Ä¢ –í—ã–±–æ—Ä –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –±–ª–æ–∫–æ–≤ (D250-D800)

üèóÔ∏è <b>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–æ–µ–Ω–∏—è:</b>
‚Ä¢ –ü–µ—Ä–∏–º–µ—Ç—Ä –∏ –≤—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω
‚Ä¢ –í—ã–±–æ—Ä —Ç–æ–ª—â–∏–Ω—ã –∫–ª–∞–¥–∫–∏ (0.5, 1, 1.5, 2 –º–∞—Ç–µ—Ä–∏–∞–ª–∞)
‚Ä¢ –¢–∏–ø —Ä–∞—Å—Ç–≤–æ—Ä–∞/–∫–ª–µ—è –∏ —Ç–æ–ª—â–∏–Ω–∞ —à–≤–æ–≤

üî∫ <b>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:</b>
‚Ä¢ –§—Ä–æ–Ω—Ç–æ–Ω—ã –ª—é–±—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ (—Ç—Ä–µ—É–≥–æ–ª—å–Ω—ã–µ —Å—Ç–µ–Ω—ã)
‚Ä¢ –û–∫–Ω–∞ –∏ –¥–≤–µ—Ä–∏ - —Ç–æ—á–Ω—ã–π –≤—ã—á–µ—Ç –ø–ª–æ—â–∞–¥–∏
‚Ä¢ –ù–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–ø–æ–≤ –ø—Ä–æ–µ–º–æ–≤ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤

üï∏Ô∏è <b>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:</b>
‚Ä¢ –ö–ª–∞–¥–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞ —Å –≤—ã–±–æ—Ä–æ–º –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏
‚Ä¢ –†–∞—Å—á–µ—Ç –æ–±—ä–µ–º–∞ —Ä–∞—Å—Ç–≤–æ—Ä–∞/–∫–ª–µ—è
‚Ä¢ –¢–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—è–¥–æ–≤ –∫–ª–∞–¥–∫–∏

‚öñÔ∏è <b>–ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã:</b>
‚Ä¢ –û–±—â–∏–π –≤–µ—Å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
‚Ä¢ –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç (–∫–ù)
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ—á–Ω–æ—Å—Ç–∏

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚ö° <b>–ü–†–û–°–¢–û–ô –†–ê–°–ß–ï–¢</b> - –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
‚Ä¢ –í–≤–æ–¥ —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ (–¥–ª–∏–Ω–∞√ó—à–∏—Ä–∏–Ω–∞√ó–≤—ã—Å–æ—Ç–∞)
‚Ä¢ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
‚Ä¢ –ë–∞–∑–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–µ–∑ —É—á–µ—Ç–∞ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π


–ö–∞–∫–æ–π —Ä–µ–∂–∏–º –≤—ã–±–µ—Ä–µ—Ç–µ?
"""
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üéØ –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç", callback_data="detailed_calculation")],
        [InlineKeyboardButton(text="‚ö° –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç", callback_data="simple_calculation")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
    ])
    
    await callback.message.edit_text(calculation_text, parse_mode="HTML", reply_markup=keyboard)
    await callback.answer()
    log_audit(callback.from_user.id, callback.from_user.username, "view_calculator_menu", "–û—Ç–∫—Ä—ã—Ç–æ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞")

@dp.callback_query(F.data == "detailed_calculation")
async def show_advanced_calculation(callback: CallbackQuery):
    calculation_text = """
üéØ –î–ï–¢–ê–õ–¨–ù–´–ô –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†

–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞:

‚Ä¢ üß± <b>–ö–∏—Ä–ø–∏—á</b> - –≤—Å–µ –≤–∏–¥—ã, —Ä–∞–∑–º–µ—Ä—ã, –ø—É—Å—Ç–æ—Ç–Ω–æ—Å—Ç—å
‚Ä¢ üèóÔ∏è <b>–ì–∞–∑–æ–±–µ—Ç–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏</b> - —Å –ø–ª–æ—Ç–Ω–æ—Å—Ç—å—é –∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
‚Ä¢ üß± <b>–ü–µ–Ω–æ–±–ª–æ–∫–∏</b> - —Å —É—á–µ—Ç–æ–º –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ D250-D800
‚Ä¢ üèóÔ∏è <b>–ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏</b> - –ø–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–µ—Ä–∞–º–∏–∫–∞

<b>–î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤–∫–ª—é—á–∞–µ—Ç:</b>
‚úÖ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞
‚úÖ –§—Ä–æ–Ω—Ç–æ–Ω—ã –∏ –ø—Ä–æ–µ–º—ã
‚úÖ –ö–ª–∞–¥–æ—á–Ω—É—é —Å–µ—Ç–∫—É  
‚úÖ –†–∞—Å—á–µ—Ç —Ä–∞—Å—Ç–≤–æ—Ä–∞
‚úÖ –ù–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
‚úÖ –ò—Ç–æ–≥–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
"""
    await callback.message.edit_text(calculation_text, parse_mode="HTML", reply_markup=get_detailed_calculation_keyboard())
    await callback.answer()
    log_audit(callback.from_user.id, callback.from_user.username, "view_detailed_calculator", "–û—Ç–∫—Ä—ã—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä")

@dp.callback_query(F.data == "simple_calculation")
async def show_simple_calculation(callback: CallbackQuery):
    calculation_text = """
‚ö° –ü–†–û–°–¢–û–ô –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†

–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞:

‚Ä¢ üß± <b>–ö–∏—Ä–ø–∏—á</b> - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
‚Ä¢ üèóÔ∏è <b>–ì–∞–∑–æ–±–µ—Ç–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏</b> - —Ç–∏–ø–æ–≤—ã–µ –±–ª–æ–∫–∏  
‚Ä¢ üß± <b>–ü–µ–Ω–æ–±–ª–æ–∫–∏</b> - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
‚Ä¢ üèóÔ∏è <b>–ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏</b> - –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

<b>–ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç:</b>
‚úÖ –ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ —Ä–∞–∑–º–µ—Ä–æ–≤ —Å—Ç—Ä–æ–µ–Ω–∏—è
‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
"""
    await callback.message.edit_text(calculation_text, parse_mode="HTML", reply_markup=get_simple_calculation_keyboard())
    await callback.answer()
    log_audit(callback.from_user.id, callback.from_user.username, "view_simple_calculator", "–û—Ç–∫—Ä—ã—Ç –ø—Ä–æ—Å—Ç–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä")

@dp.callback_query(F.data.startswith("simple_calc_"))
async def start_simple_calculation(callback: CallbackQuery, state: FSMContext):
    material_type = callback.data.replace("simple_calc_", "")
    
    material_names = {
        "bricks": "–∫–∏—Ä–ø–∏—á–∞",
        "gas_blocks": "–≥–∞–∑–æ–±–µ—Ç–æ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤",
        "foam_blocks": "–ø–µ–Ω–æ–±–ª–æ–∫–æ–≤", 
        "ceramic_blocks": "–∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤"
    }
    
    material_name = material_names.get(material_type, material_type)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    await state.update_data(simple_material_type=material_type)
    
    instruction_text = f"""
‚ö° –ü–†–û–°–¢–û–ô –†–ê–°–ß–ï–¢ {material_name.upper()}

üìè <b>–†–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</b>

–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ –º–µ—Ç—Ä–∞—Ö:

<b>–ü—Ä–∏–º–µ—Ä—ã:</b>
‚Ä¢ –°—Ç–µ–Ω–∞: 10 –º
‚Ä¢ –î–æ–º –ø–æ –ø–µ—Ä–∏–º–µ—Ç—Ä—É: 30 –º  
‚Ä¢ –ì–∞—Ä–∞–∂: 20 –º

<b>–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –≤ –º–µ—Ç—Ä–∞—Ö:</b>
"""
    
    await callback.message.edit_text(instruction_text, parse_mode="HTML")
    await state.set_state(SimpleCalculationState.entering_length)
    await callback.answer()
    log_audit(callback.from_user.id, callback.from_user.username, f"start_simple_{material_type}", f"–ù–∞—á–∞—Ç –ø—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç {material_name}")

@dp.message(SimpleCalculationState.entering_length)
async def handle_simple_length(message: Message, state: FSMContext):
    try:
        length = float(message.text.strip())
        if length <= 0:
            await message.answer("‚ùå –î–ª–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –≤ –º–µ—Ç—Ä–∞—Ö:")
            return
            
        await state.update_data(simple_length=length)
        
        await message.answer("""
üìè <b>–®–∏—Ä–∏–Ω–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</b>

–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É (—Ç–æ–ª—â–∏–Ω—É —Å—Ç–µ–Ω—ã) –≤ –º–µ—Ç—Ä–∞—Ö:

<b>–¢–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:</b>
‚Ä¢ –ö–∏—Ä–ø–∏—á –≤ –ø–æ–ª–∫–∏—Ä–ø–∏—á–∞: 0.12 –º
‚Ä¢ –ö–∏—Ä–ø–∏—á –≤ –∫–∏—Ä–ø–∏—á: 0.25 –º
‚Ä¢ –ë–ª–æ–∫–∏: 0.2-0.4 –º

<b>–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –≤ –º–µ—Ç—Ä–∞—Ö:</b>
""", parse_mode="HTML")
        await state.set_state(SimpleCalculationState.entering_width)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –¥–ª–∏–Ω—ã:")

@dp.message(SimpleCalculationState.entering_width)
async def handle_simple_width(message: Message, state: FSMContext):
    try:
        width = float(message.text.strip())
        if width <= 0:
            await message.answer("‚ùå –®–∏—Ä–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –≤ –º–µ—Ç—Ä—ã:")
            return
            
        await state.update_data(simple_width=width)
        
        await message.answer("""
üìè <b>–í—ã—Å–æ—Ç–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</b>

–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –≤ –º–µ—Ç—Ä—ã:

<b>–¢–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:</b>
‚Ä¢ –°—Ç–µ–Ω–∞ –¥–æ–º–∞: 2.5-3.0 –º
‚Ä¢ –ó–∞–±–æ—Ä: 1.5-2.0 –º
‚Ä¢ –ü–æ–¥–≤–∞–ª: 2.0-2.5 –º

<b>–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –≤ –º–µ—Ç—Ä–∞—Ö:</b>
""", parse_mode="HTML")
        await state.set_state(SimpleCalculationState.entering_height)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è —à–∏—Ä–∏–Ω—ã:")

@dp.message(SimpleCalculationState.entering_height)
async def handle_simple_height(message: Message, state: FSMContext):
    try:
        height = float(message.text.strip())
        if height <= 0:
            await message.answer("‚ùå –í—ã—Å–æ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –≤ –º–µ—Ç—Ä—ã:")
            return
            
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
        user_data = await state.get_data()
        material_type = user_data['simple_material_type']
        length = user_data['simple_length']
        width = user_data['simple_width']
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç
        result = perform_simple_calculation(material_type, length, width, height)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result_text = format_simple_calculation_result(result, material_type, length, width, height)
        
        # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        result_keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üîÑ –ù–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç", callback_data="simple_calculation")],
            [InlineKeyboardButton(text="üéØ –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç", callback_data="detailed_calculation")],
            [InlineKeyboardButton(text="‚óÄÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
        ])
        
        await message.answer(result_text, reply_markup=result_keyboard)
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        log_audit(message.from_user.id, message.from_user.username, 
                 f"simple_calculation_{material_type}", 
                 f"–†–∞–∑–º–µ—Ä—ã: {length}x{width}x{height}–º, –†–µ–∑—É–ª—å—Ç–∞—Ç: {result.get('quantity', 0)} —à—Ç.")
        
        await state.clear()
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –≤—ã—Å–æ—Ç—ã:")
    except Exception as e:
        await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        await state.clear()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ - –ö–ò–†–ü–ò–ß
@dp.callback_query(F.data == "calc_bricks")
async def start_brick_calculation_handler(callback: CallbackQuery, state: FSMContext):
    await state.update_data(material_type="bricks", calculation_params={})
    await state.set_state(CalculationState.choosing_material)
    
    instruction_text = """
üß± –î–ï–¢–ê–õ–¨–ù–´–ô –†–ê–°–ß–ï–¢ –ö–ò–†–ü–ò–ß–ê

üìè <b>–®–∞–≥ 1: –†–∞–∑–º–µ—Ä—ã –∫–∏—Ä–ø–∏—á–∞</b>

–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –∫–∏—Ä–ø–∏—á–∞ –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö:

–ü—Ä–∏–º–µ—Ä—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤:
‚Ä¢ –û–¥–∏–Ω–∞—Ä–Ω—ã–π: 250 –º–º
‚Ä¢ –ü–æ–ª—É—Ç–æ—Ä–Ω—ã–π: 250 –º–º  
‚Ä¢ –î–≤–æ–π–Ω—ã–π: 250 –º–º
‚Ä¢ –ú–æ–¥—É–ª—å–Ω—ã–π: 288 –º–º

<b>–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –≤ –º–º:</b>
"""
    await callback.message.edit_text(instruction_text, parse_mode="HTML")
    await state.set_state(CalculationState.entering_brick_length)
    await callback.answer()
    log_audit(callback.from_user.id, callback.from_user.username, "start_brick_calculation", "–ù–∞—á–∞—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∫–∏—Ä–ø–∏—á–∞")

@dp.message(CalculationState.entering_brick_length)
async def handle_brick_length_input(message: Message, state: FSMContext):
    try:
        length = float(message.text.strip())
        if length <= 0:
            await message.answer("‚ùå –î–ª–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –∫–∏—Ä–ø–∏—á–∞ –≤ –º–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['brick_length'] = length
        await state.update_data(calculation_params=params)
        
        await message.answer("""
üìè <b>–®–∞–≥ 2: –®–∏—Ä–∏–Ω–∞ –∫–∏—Ä–ø–∏—á–∞</b>

–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –∫–∏—Ä–ø–∏—á–∞ –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö:

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã:
‚Ä¢ –û–¥–∏–Ω–∞—Ä–Ω—ã–π: 120 –º–º
‚Ä¢ –ü–æ–ª—É—Ç–æ—Ä–Ω—ã–π: 120 –º–º  
‚Ä¢ –î–≤–æ–π–Ω—ã–π: 120 –º–º
‚Ä¢ –ï–≤—Ä–æ: 85 –º–º

<b>–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É:</b>
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_brick_width)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –¥–ª–∏–Ω—ã –∫–∏—Ä–ø–∏—á–∞:")

@dp.message(CalculationState.entering_brick_width)
async def handle_brick_width_input(message: Message, state: FSMContext):
    try:
        width = float(message.text.strip())
        if width <= 0:
            await message.answer("‚ùå –®–∏—Ä–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –∫–∏—Ä–ø–∏—á–∞ –≤ –º–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['brick_width'] = width
        await state.update_data(calculation_params=params)
        
        await message.answer("""
üìè <b>–®–∞–≥ 3: –í—ã—Å–æ—Ç–∞ –∫–∏—Ä–ø–∏—á–∞</b>

–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –∫–∏—Ä–ø–∏—á–∞ –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö:

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã:
‚Ä¢ –û–¥–∏–Ω–∞—Ä–Ω—ã–π: 65 –º–º
‚Ä¢ –ü–æ–ª—É—Ç–æ—Ä–Ω—ã–π: 88 –º–º
‚Ä¢ –î–≤–æ–π–Ω—ã–π: 140 –º–º

<b>–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É</b>:
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_brick_height)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è —à–∏—Ä–∏–Ω—ã –∫–∏—Ä–ø–∏—á–∞:")

@dp.message(CalculationState.entering_brick_height)
async def handle_brick_height_input(message: Message, state: FSMContext):
    try:
        height = float(message.text.strip())
        if height <= 0:
            await message.answer("‚ùå –í—ã—Å–æ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –∫–∏—Ä–ø–∏—á–∞ –≤ –º–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['brick_height'] = height
        await state.update_data(calculation_params=params)
        
        await message.answer("""
‚öñÔ∏è  <b>–®–∞–≥ 4: –í–µ—Å –∫–∏—Ä–ø–∏—á–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</b>

–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –æ–¥–Ω–æ–≥–æ –∫–∏—Ä–ø–∏—á–∞ –≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ "-" –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞:

–°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è:
‚Ä¢ –û–¥–∏–Ω–∞—Ä–Ω—ã–π –ø–æ–ª–Ω–æ—Ç–µ–ª—ã–π: 3.3-3.6 –∫–≥
‚Ä¢ –ü–æ–ª—É—Ç–æ—Ä–Ω—ã–π –ø–æ–ª–Ω–æ—Ç–µ–ª—ã–π: 4.0-4.3 –∫–≥
‚Ä¢ –î–≤–æ–π–Ω—ã–π –ø–æ–ª–Ω–æ—Ç–µ–ª—ã–π: 6.6-7.2 –∫–≥
‚Ä¢ –ü—É—Å—Ç–æ—Ç–µ–ª—ã–π: –Ω–∞ 30-40% –ª–µ–≥—á–µ

–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –∏–ª–∏ "-":
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_brick_weight)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –≤—ã—Å–æ—Ç—ã –∫–∏—Ä–ø–∏—á–∞:")

@dp.message(CalculationState.entering_brick_weight)
async def handle_brick_weight_input(message: Message, state: FSMContext):
    try:
        data = await state.get_data()
        params = data.get('calculation_params', {})
        
        if message.text.strip() == "-":
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω–∏–π –≤–µ—Å
            length = params['brick_length']
            if length <= 250:
                params['brick_weight'] = 3.5  # –°—Ä–µ–¥–Ω–∏–π –≤–µ—Å –æ–¥–∏–Ω–∞—Ä–Ω–æ–≥–æ
            else:
                params['brick_weight'] = 4.2  # –°—Ä–µ–¥–Ω–∏–π –≤–µ—Å –ø–æ–ª—É—Ç–æ—Ä–Ω–æ–≥–æ/–¥–≤–æ–π–Ω–æ–≥–æ
        else:
            weight = float(message.text.strip())
            if weight <= 0:
                await message.answer("‚ùå –í–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –∫–∏—Ä–ø–∏—á–∞ –≤ –∫–≥ –∏–ª–∏ '-':")
                return
            params['brick_weight'] = weight
            
        await state.update_data(calculation_params=params)
        
        await message.answer("""
üï≥Ô∏è <b>–®–∞–≥ 5: –ü—É—Å—Ç–æ—Ç–Ω–æ—Å—Ç—å –∫–∏—Ä–ø–∏—á–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</b>

–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç –ø—É—Å—Ç–æ—Ç–Ω–æ—Å—Ç–∏ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ "-" –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞:

–¢–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
‚Ä¢ –ü–æ–ª–Ω–æ—Ç–µ–ª—ã–π: 0-13%
‚Ä¢ –£—Å–ª–æ–≤–Ω–æ-–ø–æ–ª–Ω–æ—Ç–µ–ª—ã–π: 14-20%
‚Ä¢ –ü—É—Å—Ç–æ—Ç–µ–ª—ã–π: 21-45%
‚Ä¢ –í—ã—Å–æ–∫–æ–ø—É—Å—Ç–æ—Ç–Ω—ã–π: 46-60%

–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç (0-60) –∏–ª–∏ "-":
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_brick_pulsatility)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –≤–µ—Å–∞ –∫–∏—Ä–ø–∏—á–∞ –∏–ª–∏ '-' –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞:")

@dp.message(CalculationState.entering_brick_pulsatility)
async def handle_brick_pulsatility_input(message: Message, state: FSMContext):
    try:
        data = await state.get_data()
        params = data.get('calculation_params', {})
        
        if message.text.strip() == "-":
            params['brick_pulsatility'] = 0  # –ü–æ–ª–Ω–æ—Ç–µ–ª—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        else:
            pulsatility = float(message.text.strip())
            if pulsatility < 0 or pulsatility > 60:
                await message.answer("‚ùå –ü—É—Å—Ç–æ—Ç–Ω–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ 60%. –í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç –∏–ª–∏ '-':")
                return
            params['brick_pulsatility'] = pulsatility
            
        await state.update_data(calculation_params=params)
        await ask_perimeter(message, state)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –ø—É—Å—Ç–æ—Ç–Ω–æ—Å—Ç–∏ –∫–∏—Ä–ø–∏—á–∞ –∏–ª–∏ '-' –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞:")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ - –°–¢–ï–ù–û–í–´–ï –ë–õ–û–ö–ò
@dp.callback_query(F.data == "calc_wall_blocks")
async def start_wall_blocks_calculation_handler(callback: CallbackQuery, state: FSMContext):
    await state.update_data(material_type="wall_blocks", calculation_params={})
    await state.set_state(CalculationState.choosing_material)
    
    instruction_text = """
üèóÔ∏è –î–ï–¢–ê–õ–¨–ù–´–ô –†–ê–°–ß–ï–¢ –°–¢–ï–ù–û–í–´–• –ë–õ–û–ö–û–í

üìè <b>–®–∞–≥ 1: –†–∞–∑–º–µ—Ä—ã –±–ª–æ–∫–∞</b>

–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –±–ª–æ–∫–∞ –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö:

–ü—Ä–∏–º–µ—Ä—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤:
‚Ä¢ –ö–µ—Ä–∞–º–∑–∏—Ç–æ–±–µ—Ç–æ–Ω–Ω—ã–µ: 390 –º–º
‚Ä¢ –®–ª–∞–∫–æ–±–ª–æ–∫–∏: 390 –º–º
‚Ä¢ –ì–∞–∑–æ–±–µ—Ç–æ–Ω–Ω—ã–µ: 600 –º–º
‚Ä¢ –ü–µ–Ω–æ–±–µ—Ç–æ–Ω–Ω—ã–µ: 600 –º–º

<b>–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –≤ –º–º:</b>
"""
    
    await callback.message.edit_text(instruction_text, parse_mode="HTML")
    await state.set_state(CalculationState.entering_block_length)
    await callback.answer()
    log_audit(callback.from_user.id, callback.from_user.username, "start_wall_blocks_calculation", "–ù–∞—á–∞—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ç–µ–Ω–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ - –ü–ï–ù–û–ë–õ–û–ö–ò
@dp.callback_query(F.data == "calc_foam_blocks")
async def start_foam_blocks_calculation_handler(callback: CallbackQuery, state: FSMContext):
    await state.update_data(material_type="foam_blocks", calculation_params={})
    await state.set_state(CalculationState.choosing_material)
    
    instruction_text = """
üß± –î–ï–¢–ê–õ–¨–ù–´–ô –†–ê–°–ß–ï–¢ –ü–ï–ù–û–ë–õ–û–ö–û–í

üìè <b>–®–∞–≥ 1: –†–∞–∑–º–µ—Ä—ã –±–ª–æ–∫–∞</b>

–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –ø–µ–Ω–æ–±–ª–æ–∫–∞ –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö:

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã:
‚Ä¢ 600√ó300√ó200 –º–º
‚Ä¢ 600√ó400√ó200 –º–º  
‚Ä¢ 625√ó500√ó250 –º–º

<b>–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –≤ –º–º:</b>
"""
    await callback.message.edit_text(instruction_text, parse_mode="HTML")
    await state.set_state(CalculationState.entering_block_length)
    await callback.answer()
    log_audit(callback.from_user.id, callback.from_user.username, "start_foam_blocks_calculation", "–ù–∞—á–∞—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø–µ–Ω–æ–±–ª–æ–∫–æ–≤")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ - –ì–ê–ó–û–ë–õ–û–ö–ò
@dp.callback_query(F.data == "calc_gas_blocks")
async def start_gas_blocks_calculation_handler(callback: CallbackQuery, state: FSMContext):
    await state.update_data(material_type="gas_blocks", calculation_params={})
    await state.set_state(CalculationState.choosing_material)
    
    instruction_text = """
üèóÔ∏è –î–ï–¢–ê–õ–¨–ù–´–ô –†–ê–°–ß–ï–¢ –ì–ê–ó–û–ë–ï–¢–û–ù–ù–´–• –ë–õ–û–ö–û–í

üìè <b>–®–∞–≥ 1: –†–∞–∑–º–µ—Ä—ã –±–ª–æ–∫–∞</b>

–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –≥–∞–∑–æ–±–ª–æ–∫–∞ –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö:

–°—Ç–∞–Ω–¥–∞—Ä–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã:
‚Ä¢ 600√ó300√ó200 –º–º
‚Ä¢ 625√ó250√ó250 –º–º
‚Ä¢ 625√ó400√ó250 –º–º

<b>–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –≤ –º–º:</b>
"""
    await callback.message.edit_text(instruction_text, parse_mode="HTML")
    await state.set_state(CalculationState.entering_block_length)
    await callback.answer()
    log_audit(callback.from_user.id, callback.from_user.username, "start_gas_blocks_calculation", "–ù–∞—á–∞—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≥–∞–∑–æ–±–µ—Ç–æ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ - –ö–ï–†–ê–ú–ò–ß–ï–°–ö–ò–ï –ë–õ–û–ö–ò
@dp.callback_query(F.data == "calc_ceramic_blocks")
async def start_ceramic_blocks_calculation_handler(callback: CallbackQuery, state: FSMContext):
    await state.update_data(material_type="ceramic_blocks", calculation_params={})
    await state.set_state(CalculationState.choosing_material)
    
    instruction_text = """
üß± –î–ï–¢–ê–õ–¨–ù–´–ô –†–ê–°–ß–ï–¢ –ö–ï–†–ê–ú–ò–ß–ï–°–ö–ò–• –ë–õ–û–ö–û–í

üìè <b>–®–∞–≥ 1: –†–∞–∑–º–µ—Ä—ã –±–ª–æ–∫–∞</b>

–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–æ–≥–æ –±–ª–æ–∫–∞ –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö:

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã:
‚Ä¢ 510√ó250√ó219 –º–º (14.3 –ù–§)
‚Ä¢ 380√ó250√ó219 –º–º (10.7 –ù–§)
‚Ä¢ 510√ó120√ó219 –º–º (6.8 –ù–§)

<b>–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –≤ –º–º:</b>
"""
    await callback.message.edit_text(instruction_text, parse_mode="HTML")
    await state.set_state(CalculationState.entering_block_length)
    await callback.answer()
    log_audit(callback.from_user.id, callback.from_user.username, "start_ceramic_blocks_calculation", "–ù–∞—á–∞—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤")

# –û–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –±–ª–æ–∫–æ–≤
@dp.message(CalculationState.entering_block_length)
async def handle_block_length_input(message: Message, state: FSMContext):
    try:
        length = float(message.text.strip())
        if length <= 0:
            await message.answer("‚ùå –î–ª–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –±–ª–æ–∫–∞ –≤ –º–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['block_length'] = length
        await state.update_data(calculation_params=params)
        
        await message.answer("""
üìè <b>–®–∞–≥ 2: –®–∏—Ä–∏–Ω–∞ –±–ª–æ–∫–∞</b>

–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –±–ª–æ–∫–∞ –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö:

–°—Ç–∞–Ω–¥–∞—Ä–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã:
‚Ä¢ –ü–µ–Ω–æ–±–ª–æ–∫–∏: 100-600 –º–º
‚Ä¢ –ì–∞–∑–æ–±–ª–æ–∫–∏: 75-500 –º–º  
‚Ä¢ –ö–µ—Ä–∞–º–æ–±–ª–æ–∫–∏: 80-250 –º–º
‚Ä¢ –°—Ç–µ–Ω–æ–≤—ã–µ –±–ª–æ–∫–∏: 190-400 –º–º

–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É:
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_block_width)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –¥–ª–∏–Ω—ã –±–ª–æ–∫–∞:")

@dp.message(CalculationState.entering_block_width)
async def handle_block_width_input(message: Message, state: FSMContext):
    try:
        width = float(message.text.strip())
        if width <= 0:
            await message.answer("‚ùå –®–∏—Ä–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –±–ª–æ–∫–∞ –≤ –º–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['block_width'] = width
        await state.update_data(calculation_params=params)
        
        await message.answer("""
üìè <b>–®–∞–≥ 3: –í—ã—Å–æ—Ç–∞ –±–ª–æ–∫–∞</b>

–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –±–ª–æ–∫–∞ –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö:

–°—Ç–∞–Ω–¥–∞—Ä–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã:
‚Ä¢ –ü–µ–Ω–æ–±–ª–æ–∫–∏: 200-600 –º–º
‚Ä¢ –ì–∞–∑–æ–±–ª–æ–∫–∏: 200-300 –º–º
‚Ä¢ –ö–µ—Ä–∞–º–æ–±–ª–æ–∫–∏: 140-219 –º–º
‚Ä¢ –°—Ç–µ–Ω–æ–≤—ã–µ –±–ª–æ–∫–∏: 188-400 –º–º

–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É:
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_block_height)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è —à–∏—Ä–∏–Ω—ã –±–ª–æ–∫–∞:")

@dp.message(CalculationState.entering_block_height)
async def handle_block_height_input(message: Message, state: FSMContext):
    try:
        height = float(message.text.strip())
        if height <= 0:
            await message.answer("‚ùå –í—ã—Å–æ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –±–ª–æ–∫–∞ –≤ –º–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        material_type = data.get('material_type')
        params['block_height'] = height
        await state.update_data(calculation_params=params)
        
        # –î–ª—è –ø–µ–Ω–æ–±–ª–æ–∫–æ–≤ –∏ –≥–∞–∑–æ–±–ª–æ–∫–æ–≤ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–ª–æ—Ç–Ω–æ—Å—Ç—å
        if material_type in ['foam_blocks', 'gas_blocks']:
            await message.answer("""
üìä <b>–®–∞–≥ 4: –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –±–ª–æ–∫–∞</b>

–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –±–ª–æ–∫–∞:

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
‚Ä¢ D250 - –¥–ª—è —É—Ç–µ–ø–ª–µ–Ω–∏—è
‚Ä¢ D300-D400 - –¥–ª—è –ø–µ—Ä–µ–≥–æ—Ä–æ–¥–æ–∫  
‚Ä¢ D500-D600 - –¥–ª—è –Ω–µ—Å—É—â–∏—Ö —Å—Ç–µ–Ω
‚Ä¢ D700-D800 - –¥–ª—è —Ü–æ–∫–æ–ª–µ–π

–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–æ—Ç–Ω–æ—Å—Ç—å:
""", parse_mode="HTML", reply_markup=get_density_keyboard())
            await state.set_state(CalculationState.entering_block_density)
        # –î–ª—è —Å—Ç–µ–Ω–æ–≤—ã—Ö –∏ –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –≤–µ—Å
        elif material_type in ['wall_blocks', 'ceramic_blocks']:
            await message.answer("""
‚öñÔ∏è <b>–í–µ—Å –±–ª–æ–∫–∞</b>

–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –æ–¥–Ω–æ–≥–æ –±–ª–æ–∫–∞ –≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö:

–ü—Ä–∏–º–µ—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
‚Ä¢ –ö–µ—Ä–∞–º–∑–∏—Ç–æ–±–µ—Ç–æ–Ω–Ω—ã–π –±–ª–æ–∫ 390x190x188: 14-16 –∫–≥
‚Ä¢ –ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–π –±–ª–æ–∫ 510x250x219: 20-22 –∫–≥
‚Ä¢ –®–ª–∞–∫–æ–±–ª–æ–∫ 390x190x188: 16-18 –∫–≥

–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –≤ –∫–≥:
""", parse_mode="HTML")
            await state.set_state(CalculationState.entering_block_weight)
        else:
            await ask_perimeter(message, state)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –≤—ã—Å–æ—Ç—ã –±–ª–æ–∫–∞:")

@dp.callback_query(F.data.startswith("density_"))
async def handle_density_selection_callback(callback: CallbackQuery, state: FSMContext):
    density = int(callback.data.split("_")[1])
    
    data = await state.get_data()
    params = data.get('calculation_params', {})
    params['density'] = density
    await state.update_data(calculation_params=params)
    
    await callback.message.edit_text(f"‚úÖ –í—ã–±—Ä–∞–Ω–∞ –ø–ª–æ—Ç–Ω–æ—Å—Ç—å D{density} –∫–≥/–º¬≥")
    await ask_perimeter(callback.message, state)
    await callback.answer()

@dp.message(CalculationState.entering_block_weight)
async def handle_block_weight_input(message: Message, state: FSMContext):
    try:
        weight = float(message.text.strip())
        if weight <= 0:
            await message.answer("‚ùå –í–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –±–ª–æ–∫–∞ –≤ –∫–≥:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['block_weight'] = weight
        await state.update_data(calculation_params=params)
        
        await ask_perimeter(message, state)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –≤–µ—Å–∞ –±–ª–æ–∫–∞:")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å—Ç—Ä–æ–µ–Ω–∏—è
@dp.message(CalculationState.entering_perimeter)
async def handle_perimeter_input(message: Message, state: FSMContext):
    try:
        perimeter = float(message.text.strip())
        if perimeter <= 0:
            await message.answer("‚ùå –ü–µ—Ä–∏–º–µ—Ç—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–∏–º–µ—Ç—Ä –≤ –º–µ—Ç—Ä—ã:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['perimeter'] = perimeter
        await state.update_data(calculation_params=params)
        
        await message.answer("""
üìê <b>–®–∞–≥ 7: –í—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω</b>

–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É —Å—Ç–µ–Ω –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö:

–¢–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
‚Ä¢ –û–¥–Ω–æ—ç—Ç–∞–∂–Ω—ã–π –¥–æ–º: 250-300 —Å–º
‚Ä¢ –ü–æ–¥–≤–∞–ª/—Ü–æ–∫–æ–ª—å: 200-250 —Å–º
‚Ä¢ –ú–∞–Ω—Å–∞—Ä–¥–∞: 150-200 —Å–º
‚Ä¢ –ì–∞—Ä–∞–∂: 240-280 —Å–º

–ï—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω —Ä–∞–∑–Ω–∞—è, —É–∫–∞–∂–∏—Ç–µ —Å—Ä–µ–¥–Ω—é—é –≤—ã—Å–æ—Ç—É.

–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö:
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_wall_height)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –ø–µ—Ä–∏–º–µ—Ç—Ä–∞:")

@dp.message(CalculationState.entering_wall_height)
async def handle_wall_height_input(message: Message, state: FSMContext):
    try:
        height = float(message.text.strip())
        if height <= 0:
            await message.answer("‚ùå –í—ã—Å–æ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –≤ —Å–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['wall_height'] = height
        await state.update_data(calculation_params=params)
        
        await message.answer("""
üß± <b>–®–∞–≥ 8: –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω</b>

–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ª—â–∏–Ω—É —Å—Ç–µ–Ω:
""", parse_mode="HTML", reply_markup=get_wall_thickness_keyboard())
        await state.set_state(CalculationState.choosing_wall_thickness)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –≤—ã—Å–æ—Ç—ã —Å—Ç–µ–Ω:")

@dp.callback_query(F.data.startswith("thickness_"))
async def handle_wall_thickness_callback(callback: CallbackQuery, state: FSMContext):
    thickness = float(callback.data.split("_")[1])
    
    data = await state.get_data()
    params = data.get('calculation_params', {})
    params['wall_thickness'] = thickness
    await state.update_data(calculation_params=params)
    
    thickness_names = {
        0.5: "–ø–æ–ª–æ–≤–∏–Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞",
        1.0: "–≤ –º–∞—Ç–µ—Ä–∏–∞–ª", 
        1.5: "–ø–æ–ª—Ç–æ—Ä–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞",
        2.0: "–¥–≤–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞"
    }
    
    await callback.message.edit_text(f"‚úÖ –í—ã–±—Ä–∞–Ω–∞ —Ç–æ–ª—â–∏–Ω–∞: {thickness_names[thickness]}")
    
    await callback.message.answer("""
üß™ <b>–®–∞–≥ 9: –¢–æ–ª—â–∏–Ω–∞ —Ä–∞—Å—Ç–≤–æ—Ä–∞/–∫–ª–µ—è</b>

–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ª—â–∏–Ω—É –∫–ª–∞–¥–æ—á–Ω–æ–≥–æ —à–≤–∞:
""", parse_mode="HTML", reply_markup=get_mortar_thickness_keyboard())
    await state.set_state(CalculationState.choosing_mortar_thickness)
    await callback.answer()

@dp.callback_query(F.data.startswith("mortar_"))
async def handle_mortar_thickness_callback(callback: CallbackQuery, state: FSMContext):
    thickness = int(callback.data.split("_")[1])
    
    data = await state.get_data()
    params = data.get('calculation_params', {})
    params['mortar_thickness'] = thickness
    await state.update_data(calculation_params=params)
    
    mortar_names = {
        2: "2 –º–º (—Ç–æ–Ω–∫–æ—à–æ–≤–Ω—ã–π –∫–ª–µ–π)",
        3: "3 –º–º (–º–æ–Ω—Ç–∞–∂–Ω–∞—è –ø–µ–Ω–∞)",
        10: "10 –º–º (—Ü–µ–º–µ–Ω—Ç–Ω—ã–π —Ä–∞—Å—Ç–≤–æ—Ä)",
        15: "15 –º–º (—Ü–µ–º–µ–Ω—Ç–Ω—ã–π —Ä–∞—Å—Ç–≤–æ—Ä)",
        20: "20 –º–º (—Ü–µ–º–µ–Ω—Ç–Ω—ã–π —Ä–∞—Å—Ç–≤–æ—Ä)"
    }
    
    await callback.message.edit_text(f"‚úÖ –í—ã–±—Ä–∞–Ω–∞ —Ç–æ–ª—â–∏–Ω–∞ —à–≤–∞: {mortar_names[thickness]}")
    await ask_about_gables(callback.message, state)
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ—Ä–æ–Ω—Ç–æ–Ω–æ–≤
@dp.callback_query(F.data == "gables_yes")
async def handle_gables_yes_callback(callback: CallbackQuery, state: FSMContext):
    await callback.message.edit_text("""
üî∫ <b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—Ä–æ–Ω—Ç–æ–Ω–æ–≤</b>

–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—Ä–æ–Ω—Ç–æ–Ω–æ–≤ (–æ–±—ã—á–Ω–æ 2):
""", parse_mode="HTML")
    await state.set_state(CalculationState.entering_gables_count)
    await callback.answer()

@dp.callback_query(F.data == "gables_no")
async def handle_gables_no_callback(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    params = data.get('calculation_params', {})
    params['gables'] = []
    await state.update_data(calculation_params=params)
    
    await callback.message.edit_text("‚úÖ –§—Ä–æ–Ω—Ç–æ–Ω—ã –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è")
    await ask_about_openings(callback.message, state)
    await callback.answer()

@dp.message(CalculationState.entering_gables_count)
async def handle_gables_count_input(message: Message, state: FSMContext):
    try:
        count = int(message.text.strip())
        if count <= 0:
            await message.answer("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—Ä–æ–Ω—Ç–æ–Ω–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['gables_count'] = count
        params['gables'] = []
        params['current_gable'] = 1
        await state.update_data(calculation_params=params)
        
        await message.answer(f"""
üìê <b>–§—Ä–æ–Ω—Ç–æ–Ω ‚Ññ1</b>

–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –æ—Å–Ω–æ–≤–∞–Ω–∏—è —Ñ—Ä–æ–Ω—Ç–æ–Ω–∞ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö:

–û–±—ã—á–Ω–æ —Ä–∞–≤–Ω–∞ —à–∏—Ä–∏–Ω–µ –¥–æ–º–∞.
–ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –¥–æ–º–∞ 8√ó10 –º —à–∏—Ä–∏–Ω–∞ —Ñ—Ä–æ–Ω—Ç–æ–Ω–∞ = 800 —Å–º

–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –≤ —Å–º:
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_gable_width)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ—Ä–æ–Ω—Ç–æ–Ω–æ–≤:")

@dp.message(CalculationState.entering_gable_width)
async def handle_gable_width_input(message: Message, state: FSMContext):
    try:
        width = float(message.text.strip())
        if width <= 0:
            await message.answer("‚ùå –®–∏—Ä–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –≤ —Å–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['current_gable_width'] = width
        await state.update_data(calculation_params=params)
        
        current_gable = params['current_gable']
        await message.answer(f"""
üìê <b>–§—Ä–æ–Ω—Ç–æ–Ω ‚Ññ{current_gable}</b>

–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É —Ñ—Ä–æ–Ω—Ç–æ–Ω–∞ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä—ã:

–ò–∑–º–µ—Ä—è–µ—Ç—Å—è –æ—Ç –æ—Å–Ω–æ–≤–∞–Ω–∏—è –¥–æ –∫–æ–Ω—å–∫–∞ –∫—Ä—ã—à–∏.
–¢–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: 100-300 —Å–º

–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –≤ —Å–º:
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_gable_height)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è —à–∏—Ä–∏–Ω—ã —Ñ—Ä–æ–Ω—Ç–æ–Ω–∞:")

@dp.message(CalculationState.entering_gable_height)
async def handle_gable_height_input(message: Message, state: FSMContext):
    try:
        height = float(message.text.strip())
        if height <= 0:
            await message.answer("‚ùå –í—ã—Å–æ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –≤ —Å–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ñ—Ä–æ–Ω—Ç–æ–Ω
        gable = {
            'width': params['current_gable_width'],
            'height': height
        }
        params['gables'].append(gable)
        
        current_gable = params['current_gable']
        gables_count = params['gables_count']
        
        if current_gable < gables_count:
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ñ—Ä–æ–Ω—Ç–æ–Ω—É
            params['current_gable'] = current_gable + 1
            await state.update_data(calculation_params=params)
            
            await message.answer(f"""
üìê <b>–§—Ä–æ–Ω—Ç–æ–Ω ‚Ññ{current_gable + 1}</b>

–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –æ—Å–Ω–æ–≤–∞–Ω–∏—è —Ñ—Ä–æ–Ω—Ç–æ–Ω–∞ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö:

–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –≤ —Å–º:
""", parse_mode="HTML")
            await state.set_state(CalculationState.entering_gable_width)
        else:
            # –í—Å–µ —Ñ—Ä–æ–Ω—Ç–æ–Ω—ã –≤–≤–µ–¥–µ–Ω—ã
            await state.update_data(calculation_params=params)
            await message.answer(f"‚úÖ –í—Å–µ {gables_count} —Ñ—Ä–æ–Ω—Ç–æ–Ω–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω—ã")
            await ask_about_openings(message, state)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –≤—ã—Å–æ—Ç–∞ —Ñ—Ä–æ–Ω—Ç–æ–Ω–∞:")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–æ–µ–º–æ–≤
@dp.callback_query(F.data == "openings_yes")
async def handle_openings_yes_callback(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    params = data.get('calculation_params', {})
    params['openings'] = []
    await state.update_data(calculation_params=params)
    
    await callback.message.edit_text("""
ü™ü <b>–û–∫–Ω–∞</b>

–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∫–æ–Ω –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞:

–ù–∞–ø—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ —É –≤–∞—Å 4 –æ–∫–Ω–∞ —Ä–∞–∑–º–µ—Ä–æ–º 120√ó140 —Å–º, –≤–≤–µ–¥–∏—Ç–µ 4.
–ï—Å–ª–∏ –æ–∫–Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤, —Å–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö.

–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∫–æ–Ω:
""", parse_mode="HTML")
    await state.set_state(CalculationState.entering_windows_count)
    await callback.answer()

@dp.callback_query(F.data == "openings_no")
async def handle_openings_no_callback(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    params = data.get('calculation_params', {})
    params['openings'] = []
    await state.update_data(calculation_params=params)
    
    await callback.message.edit_text("‚úÖ –ü—Ä–æ–µ–º—ã –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è")
    await ask_about_mesh(callback.message, state)
    await callback.answer()

@dp.message(CalculationState.entering_windows_count)
async def handle_windows_count_input(message: Message, state: FSMContext):
    try:
        count = int(message.text.strip())
        if count <= 0:
            await message.answer("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∫–æ–Ω –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['current_windows_count'] = count
        await state.update_data(calculation_params=params)
        
        await message.answer(f"""
ü™ü <b>–†–∞–∑–º–µ—Ä—ã –æ–∫–æ–Ω ({count} —à—Ç.)</b>

–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –æ–∫–Ω–∞ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö:

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –æ–∫–æ–Ω:
‚Ä¢ 60√ó60, 60√ó90, 60√ó120 —Å–º
‚Ä¢ 90√ó90, 90√ó120, 90√ó150 —Å–º  
‚Ä¢ 120√ó120, 120√ó140, 120√ó160 —Å–º
‚Ä¢ 150√ó120, 150√ó140, 150√ó160 —Å–º

–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –≤ —Å–º:
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_window_width)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–∫–æ–Ω:")

@dp.message(CalculationState.entering_window_width)
async def handle_window_width_input(message: Message, state: FSMContext):
    try:
        width = float(message.text.strip())
        if width <= 0:
            await message.answer("‚ùå –®–∏—Ä–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –≤ —Å–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['current_window_width'] = width
        await state.update_data(calculation_params=params)
        
        count = params['current_windows_count']
        await message.answer(f"""
ü™ü <b>–†–∞–∑–º–µ—Ä—ã –æ–∫–æ–Ω ({count} —à—Ç.)</b>

–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –æ–∫–Ω–∞ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö:

–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –≤ —Å–º:
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_window_height)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è —à–∏—Ä–∏–Ω—ã –æ–∫–Ω–∞:")

@dp.message(CalculationState.entering_window_height)
async def handle_window_height_input(message: Message, state: FSMContext):
    try:
        height = float(message.text.strip())
        if height <= 0:
            await message.answer("‚ùå –í—ã—Å–æ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –≤ —Å–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–∫–Ω–∞
        window = {
            'width': params['current_window_width'],
            'height': height,
            'count': params['current_windows_count'],
            'type': 'window'
        }
        params['openings'].append(window)
        await state.update_data(calculation_params=params)
        
        count = params['current_windows_count']
        width = params['current_window_width']
        await message.answer(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ {count} –æ–∫–æ–Ω —Ä–∞–∑–º–µ—Ä–æ–º {width}√ó{height} —Å–º")
        
        # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –æ –¥—Ä—É–≥–∏—Ö –æ–∫–Ω–∞—Ö
        await message.answer("""
ü™ü <b>–ï—Å—Ç—å –ª–∏ –æ–∫–Ω–∞ –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤?</b>
""", reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ –î–∞, –µ—Å—Ç—å –µ—â–µ", callback_data="more_windows_yes")],
            [InlineKeyboardButton(text="‚ùå –ù–µ—Ç, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–≤–µ—Ä—è–º", callback_data="more_windows_no")]
        ]))
        await state.set_state(CalculationState.asking_more_windows)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –≤—ã—Å–æ—Ç—ã –æ–∫–Ω–∞:")

@dp.callback_query(F.data == "more_windows_yes")
async def handle_more_windows_yes_callback(callback: CallbackQuery, state: FSMContext):
    await callback.message.edit_text("""
ü™ü <b>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–∫–Ω–∞</b>

–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∫–æ–Ω —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞:
""", parse_mode="HTML")
    await state.set_state(CalculationState.entering_windows_count)
    await callback.answer()

@dp.callback_query(F.data == "more_windows_no")
async def handle_more_windows_no_callback(callback: CallbackQuery, state: FSMContext):
    await callback.message.edit_text("""
üö™ <b>–î–≤–µ—Ä–∏</b>

–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–≤–µ—Ä–µ–π –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞:

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–≤–µ—Ä–µ–π:
‚Ä¢ –í—Ö–æ–¥–Ω—ã–µ: 90√ó200, 100√ó200 —Å–º
‚Ä¢ –ú–µ–∂–∫–æ–º–Ω–∞—Ç–Ω—ã–µ: 60√ó200, 70√ó200, 80√ó200 —Å–º
‚Ä¢ –ë–∞–ª–∫–æ–Ω–Ω—ã–µ: 70√ó210, 80√ó210 —Å–º

–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–≤–µ—Ä–µ–π:
""", parse_mode="HTML")
    await state.set_state(CalculationState.entering_doors_count)
    await callback.answer()

@dp.message(CalculationState.entering_doors_count)
async def handle_doors_count_input(message: Message, state: FSMContext):
    try:
        count = int(message.text.strip())
        if count <= 0:
            await message.answer("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–≤–µ—Ä–µ–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['current_doors_count'] = count
        await state.update_data(calculation_params=params)
        
        await message.answer(f"""
üö™ <b>–†–∞–∑–º–µ—Ä—ã –¥–≤–µ—Ä–µ–π ({count} —à—Ç.)</b>
–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –¥–≤–µ—Ä–∏ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö:

–í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –≤ —Å–º:
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_door_width)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–≤–µ—Ä–µ–π:")

@dp.message(CalculationState.entering_door_width)
async def handle_door_width_input(message: Message, state: FSMContext):
    try:
        width = float(message.text.strip())
        if width <= 0:
            await message.answer("‚ùå –®–∏—Ä–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω–∞ –≤ —Å–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        params['current_door_width'] = width
        await state.update_data(calculation_params=params)
        
        count = params['current_doors_count']
        await message.answer(f"""
üö™ <b>–†–∞–∑–º–µ—Ä—ã –¥–≤–µ—Ä–µ–π ({count} —à—Ç.)</b>

–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –¥–≤–µ—Ä–∏ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö:

–í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –≤ —Å–º:
""", parse_mode="HTML")
        await state.set_state(CalculationState.entering_door_height)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è —à–∏—Ä–∏–Ω—ã –¥–≤–µ—Ä–∏:")

@dp.message(CalculationState.entering_door_height)
async def handle_door_height_input(message: Message, state: FSMContext):
    try:
        height = float(message.text.strip())
        if height <= 0:
            await message.answer("‚ùå –í—ã—Å–æ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É –≤ —Å–º:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–≤–µ—Ä–∏
        door = {
            'width': params['current_door_width'],
            'height': height,
            'count': params['current_doors_count'],
            'type': 'door'
        }
        params['openings'].append(door)
        await state.update_data(calculation_params=params)
        
        count = params['current_doors_count']
        width = params['current_door_width']
        await message.answer(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ {count} –¥–≤–µ—Ä–µ–π —Ä–∞–∑–º–µ—Ä–æ–º {width}√ó{height} —Å–º")
        
        # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –æ –¥—Ä—É–≥–∏—Ö –¥–≤–µ—Ä—è–º
        await message.answer("""
üö™ <b>–ï—Å—Ç—å –ª–∏ –¥–≤–µ—Ä–∏ –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤?</b>
""", reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ –î–∞, –µ—Å—Ç—å –µ—â–µ", callback_data="more_doors_yes")],
            [InlineKeyboardButton(text="‚ùå –ù–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º", callback_data="more_doors_no")]
        ]))
        await state.set_state(CalculationState.asking_more_doors)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –≤—ã—Å–æ—Ç—ã –¥–≤–µ—Ä–∏:")

@dp.callback_query(F.data == "more_doors_yes")
async def handle_more_doors_yes_callback(callback: CallbackQuery, state: FSMContext):
    await callback.message.edit_text("""
üö™ <b>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–≤–µ—Ä–∏</b>

–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–≤–µ—Ä–µ–π —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞:
""", parse_mode="HTML")
    await state.set_state(CalculationState.entering_doors_count)
    await callback.answer()

@dp.callback_query(F.data == "more_doors_no")
async def handle_more_doors_no_callback(callback: CallbackQuery, state: FSMContext):
    await callback.message.edit_text("‚úÖ –í—Å–µ –ø—Ä–æ–µ–º—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã")
    await ask_about_mesh(callback.message, state)
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∞–¥–æ—á–Ω–æ–π —Å–µ—Ç–∫–∏
@dp.callback_query(F.data == "mesh_yes")
async def handle_mesh_yes_callback(callback: CallbackQuery, state: FSMContext):
    await callback.message.edit_text("""
üï∏Ô∏è <b>–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –∫–ª–∞–¥–æ—á–Ω–æ–π —Å–µ—Ç–∫–∏</b>

–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫ —á–∞—Å—Ç–æ —É–∫–ª–∞–¥—ã–≤–∞—Ç—å —Å–µ—Ç–∫—É:
""", parse_mode="HTML", reply_markup=get_mesh_frequency_keyboard())
    await state.set_state(CalculationState.choosing_mesh_frequency)
    await callback.answer()

@dp.callback_query(F.data == "mesh_no")
async def handle_mesh_no_callback(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    params = data.get('calculation_params', {})
    params['mesh_frequency'] = 0
    await state.update_data(calculation_params=params)
    
    await callback.message.edit_text("‚úÖ –ö–ª–∞–¥–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è")
    await ask_about_price(callback.message, state)
    await callback.answer()

@dp.callback_query(F.data.startswith("mesh_"))
async def handle_mesh_frequency_callback(callback: CallbackQuery, state: FSMContext):
    frequency = int(callback.data.split("_")[1])
    
    data = await state.get_data()
    params = data.get('calculation_params', {})
    params['mesh_frequency'] = frequency
    await state.update_data(calculation_params=params)
    
    frequency_names = {
        0: "–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è",
        1: "–∫–∞–∂–¥—ã–π —Ä—è–¥",
        2: "—á–µ—Ä–µ–∑ —Ä—è–¥", 
        3: "—á–µ—Ä–µ–∑ 2 —Ä—è–¥–∞",
        4: "—á–µ—Ä–µ–∑ 3 —Ä—è–¥–∞",
        5: "—á–µ—Ä–µ–∑ 4 —Ä—è–¥–∞"
    }
    
    await callback.message.edit_text(f"‚úÖ –°–µ—Ç–∫–∞: {frequency_names[frequency]}")
    await ask_about_price(callback.message, state)
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ü–µ–Ω—ã
@dp.callback_query(F.data == "price_yes")
async def handle_price_yes_callback(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    material_type = data.get('material_type')
    
    price_units = {
        'bricks': '–∑–∞ —à—Ç—É–∫—É',
        'ceramic_blocks': '–∑–∞ —à—Ç—É–∫—É', 
        'wall_blocks': '–∑–∞ —à—Ç—É–∫—É',
        'foam_blocks': '–∑–∞ –∫—É–±–æ–º–µ—Ç—Ä',
        'gas_blocks': '–∑–∞ –∫—É–±–æ–º–µ—Ç—Ä'
    }
    
    unit = price_units.get(material_type, '–∑–∞ –µ–¥–∏–Ω–∏—Ü—É')
    
    await callback.message.edit_text(f"""
üí∞ <b>–¶–µ–Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</b>

–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É {unit} –≤ —Ä—É–±–ª—è—Ö:

–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É:
""", parse_mode="HTML")
    await state.set_state(CalculationState.entering_price)
    await callback.answer()

@dp.callback_query(F.data == "price_no")
async def handle_price_no_callback(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    params = data.get('calculation_params', {})
    params['price'] = 0
    await state.update_data(calculation_params=params)
    
    await callback.message.edit_text("‚úÖ –°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è")
    await show_calculation_summary(callback.message, state)
    await callback.answer()

@dp.message(CalculationState.entering_price)
async def handle_price_input_message(message: Message, state: FSMContext):
    try:
        price = float(message.text.strip())
        if price < 0:
            await message.answer("‚ùå –¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π. –í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É:")
            return
            
        data = await state.get_data()
        params = data.get('calculation_params', {})
        material_type = data.get('material_type')
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—É –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ–ª–µ
        if material_type in ['foam_blocks', 'gas_blocks']:
            params['price_per_cube'] = price
        else:
            params['price'] = price
            
        await state.update_data(calculation_params=params)
        
        await message.answer(f"‚úÖ –¶–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: {price} —Ä—É–±.")
        await show_calculation_summary(message, state)
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è —Ü–µ–Ω—ã:")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞
@dp.callback_query(F.data == "confirm_calculation")
async def handle_confirm_calculation_callback(callback: CallbackQuery, state: FSMContext):
    try:
        data = await state.get_data()
        material_type = data.get('material_type')
        params = data.get('calculation_params', {})
        
        if not material_type or not params:
            await callback.message.edit_text("‚ùå –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Ä–∞—Å—á–µ—Ç –∑–∞–Ω–æ–≤–æ.")
            await state.clear()
            await callback.answer()
            return
        
        # –í—ã–±–∏—Ä–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Ä–∞—Å—á–µ—Ç–∞
        calculation_functions = {
            'bricks': calculate_bricks_advanced,
            'wall_blocks': calculate_wall_blocks_advanced,
            'foam_blocks': calculate_foam_blocks_advanced,
            'gas_blocks': calculate_gas_blocks_advanced,
            'ceramic_blocks': calculate_ceramic_blocks_advanced
        }
        
        calc_func = calculation_functions.get(material_type)
        if not calc_func:
            await callback.message.edit_text("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞")
            await state.clear()
            await callback.answer()
            return
        
        result = calc_func(params)
        
        if "error" in result:
            result_text = f"‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: {result['error']}"
        else:
            # –í—ã–±–∏—Ä–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Ç–∏–ø—É –º–∞—Ç–µ—Ä–∏–∞–ª–∞
            format_functions = {
                'bricks': format_bricks_result,
                'wall_blocks': format_wall_blocks_result,
                'foam_blocks': format_foam_blocks_result,
                'gas_blocks': format_gas_blocks_result,
                'ceramic_blocks': format_ceramic_blocks_result
            }
            
            format_func = format_functions.get(material_type, format_general_result)
            result_text = format_func(result)
            
            log_audit(callback.from_user.id, callback.from_user.username, 
                     f"advanced_calculation_{material_type}", 
                     f"–ú–∞—Ç–µ—Ä–∏–∞–ª: {result.get('material_type', 'unknown')}, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {result.get('bricks_needed', result.get('blocks_needed', 0))}")
        
        await callback.message.edit_text(result_text, parse_mode="HTML", reply_markup=get_main_keyboard(callback.from_user.id))
        
    except Exception as e:
        error_text = f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ: {str(e)}"
        await callback.message.edit_text(error_text, reply_markup=get_main_keyboard(callback.from_user.id))
        logger.error(f"Error in handle_confirm_calculation: {e}")
    
    finally:
        await state.clear()
        await callback.answer()

@dp.callback_query(F.data == "edit_parameters")
async def handle_edit_parameters_callback(callback: CallbackQuery, state: FSMContext):
    await callback.message.edit_text("üîÑ –ö–∞–∫–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å?", reply_markup=InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìè –†–∞–∑–º–µ—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞", callback_data="edit_dimensions")],
        [InlineKeyboardButton(text="üè† –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–æ–µ–Ω–∏—è", callback_data="edit_building")],
        [InlineKeyboardButton(text="üî∫ –§—Ä–æ–Ω—Ç–æ–Ω—ã", callback_data="edit_gables")],
        [InlineKeyboardButton(text="üö™ü™ü –ü—Ä–æ–µ–º—ã", callback_data="edit_openings")],
        [InlineKeyboardButton(text="üï∏Ô∏è –ö–ª–∞–¥–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞", callback_data="edit_mesh")],
        [InlineKeyboardButton(text="üí∞ –¶–µ–Ω–∞", callback_data="edit_price")],
        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–≤–æ–¥–∫–µ", callback_data="back_to_summary")]
    ]))
    await callback.answer()

@dp.callback_query(F.data == "restart_calculation")
async def handle_restart_calculation_callback(callback: CallbackQuery, state: FSMContext):
    await state.clear()
    await callback.message.edit_text("üîÑ –†–∞—Å—á–µ—Ç —Å–±—Ä–æ—à–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –∑–∞–Ω–æ–≤–æ:", reply_markup=get_detailed_calculation_keyboard())
    await callback.answer()

@dp.callback_query(F.data == "back_to_calc")
async def back_to_calculation_callback(callback: CallbackQuery):
    await show_calculation_options(callback)
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
@dp.callback_query(F.data == "products_panel")
async def show_products_panel_callback(callback: CallbackQuery):
    if is_staff(callback.from_user.id):
        products_text = """
üõí –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –¢–û–í–ê–†–ê–ú–ò

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–∞:

‚Ä¢ ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä
‚Ä¢ ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–≤–∞—Ä  
‚Ä¢ üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –±–∞–∑—ã

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
"""
        await callback.message.edit_text(products_text, reply_markup=get_products_panel_keyboard())
        log_audit(callback.from_user.id, callback.from_user.username, "open_products_panel", "–û—Ç–∫—Ä—ã—Ç–∞ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞–º–∏")
    else:
        await callback.answer("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞")

@dp.callback_query(F.data == "admin_panel")
async def show_admin_panel_callback(callback: CallbackQuery):
    if is_admin(callback.from_user.id):
        admin_text = """
üëë –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π:

‚Ä¢ üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏ - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ
‚Ä¢ üìä –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
‚Ä¢ üìù –ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
"""
        await callback.message.edit_text(admin_text, reply_markup=get_admin_panel_keyboard())
        log_audit(callback.from_user.id, callback.from_user.username, "open_admin_panel", "–û—Ç–∫—Ä—ã—Ç–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å")
    else:
        await callback.answer("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")

@dp.callback_query(F.data == "manage_staff")
async def manage_staff_callback(callback: CallbackQuery):
    if is_admin(callback.from_user.id):
        staff_text = """
üë• –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–û–¢–†–£–î–ù–ò–ö–ê–ú–ò

‚Ä¢ ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ - –ø–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚Ä¢ üë• –°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ - –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
‚Ä¢ üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ - —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
"""
        await callback.message.edit_text(staff_text, reply_markup=get_staff_management_keyboard())
    await callback.answer()

@dp.callback_query(F.data == "add_staff")
async def start_adding_staff_callback(callback: CallbackQuery, state: FSMContext):
    if is_admin(callback.from_user.id):
        instruction_text = """
‚ûï –î–û–ë–ê–í–õ–ï–ù–ò–ï –°–û–¢–†–£–î–ù–ò–ö–ê

–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.

ID –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å:
‚Ä¢ –ü–µ—Ä–µ—Å–ª–∞–≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–æ—Ç—É @userinfobot
‚Ä¢ –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–º–∞–Ω–¥—É /add_staff <ID> –≤ —á–∞—Ç–µ

–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
"""
        await callback.message.edit_text(instruction_text)
        await state.set_state(AdminState.adding_staff)
    await callback.answer()

@dp.message(AdminState.adding_staff)
async def handle_add_staff_message(message: Message, state: FSMContext):
    try:
        user_id = int(message.text.strip())
        if add_staff(user_id, message.from_user.username, None, message.from_user.id):
            await message.answer("‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!", reply_markup=get_admin_panel_keyboard())
            log_audit(message.from_user.id, message.from_user.username, "add_staff", f"–î–æ–±–∞–≤–ª–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ ID: {user_id}")
        else:
            await message.answer("‚ùå –û—à–∏–±–∫–∞: —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π ID")
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID (—á–∏—Å–ª–æ)")
    await state.clear()

@dp.callback_query(F.data == "list_staff")
async def list_staff_callback(callback: CallbackQuery):
    if is_admin(callback.from_user.id):
        await callback.message.edit_text("üë• –°–ü–ò–°–û–ö –°–û–¢–†–£–î–ù–ò–ö–û–í:", reply_markup=get_staff_list_keyboard())
    await callback.answer()

@dp.callback_query(F.data.startswith("staff_page_"))
async def handle_staff_pagination_callback(callback: CallbackQuery):
    if is_admin(callback.from_user.id):
        page = int(callback.data.split("_")[2])
        await callback.message.edit_text("üë• –°–ü–ò–°–û–ö –°–û–¢–†–£–î–ù–ò–ö–û–í:", reply_markup=get_staff_list_keyboard(page))
    await callback.answer()

@dp.callback_query(F.data == "remove_staff")
async def show_remove_staff_callback(callback: CallbackQuery):
    if is_admin(callback.from_user.id):
        staff_list = get_all_staff()
        if staff_list:
            await callback.message.edit_text("üóëÔ∏è –í–´–ë–ï–†–ò–¢–ï –°–û–¢–†–£–î–ù–ò–ö–ê –î–õ–ê –£–î–ê–õ–ï–ù–ò–Ø:", reply_markup=get_remove_staff_keyboard())
        else:
            await callback.message.edit_text("üì≠ –ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è", reply_markup=get_staff_management_keyboard())
    await callback.answer()

@dp.callback_query(F.data.startswith("remove_staff_page_"))
async def handle_remove_staff_pagination_callback(callback: CallbackQuery):
    if is_admin(callback.from_user.id):
        page = int(callback.data.split("_")[3])
        await callback.message.edit_text("üóëÔ∏è –í–´–ë–ï–†–ò–¢–ï –°–û–¢–†–£–î–ù–ò–ö–ê –î–õ–Ø –£–î–ê–õ–ï–ù–ò–Ø:", reply_markup=get_remove_staff_keyboard(page))
    await callback.answer()

@dp.callback_query(F.data.startswith("remove_staff_"))
async def handle_remove_staff_callback(callback: CallbackQuery):
    if is_admin(callback.from_user.id):
        user_id = int(callback.data.split("_")[2])
        remove_staff(user_id)
        await callback.message.edit_text("‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!", reply_markup=get_staff_management_keyboard())
        log_audit(callback.from_user.id, callback.from_user.username, "remove_staff", f"–£–¥–∞–ª–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ ID: {user_id}")
    await callback.answer()

@dp.callback_query(F.data == "detailed_stats")
async def show_detailed_stats_callback(callback: CallbackQuery):
    if is_admin(callback.from_user.id):
        stats = get_detailed_stats()
        
        stats_text = "üìä –ü–û–î–†–û–ë–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´\n\n"
        stats_text += f"üì¶ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: {stats['total_products']}\n"
        stats_text += f"üë• –í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: {stats['total_staff']}\n"
        stats_text += f"üìù –í—Å–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ: {stats['total_actions']}\n\n"
        
        stats_text += "üìÇ –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú:\n"
        for category in stats['category_stats']:
            stats_text += f"‚Ä¢ {category[0]}: {category[1]} —Ç–æ–≤–∞—Ä–æ–≤, {category[2]} —à—Ç., {category[3]:.2f} —Ä—É–±.\n"
        
        stats_text += "\nüìà –°–ê–ú–´–ï –ê–ö–¢–ò–í–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:\n"
        for action in stats['activity_stats']:
            stats_text += f"‚Ä¢ {action[0]}: {action[1]} —Ä–∞–∑\n"
        
        stats_text += "\n‚è∞ –ü–û–°–õ–ï–î–ù–ò–ï –î–ï–ô–°–¢–í–ò–Ø:\n"
        for action in stats['recent_actions']:
            stats_text += f"‚Ä¢ {action[3]} - {action[5]}\n"
        
        await callback.message.edit_text(stats_text, reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="detailed_stats")],
            [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")]
        ]))
        log_audit(callback.from_user.id, callback.from_user.username, "view_stats", "–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
    await callback.answer()

@dp.callback_query(F.data == "audit_log")
async def show_audit_log_callback(callback: CallbackQuery):
    if is_admin(callback.from_user.id):
        await show_audit_log_page(callback, 1)
    await callback.answer()

@dp.callback_query(F.data.startswith("audit_page_"))
async def handle_audit_pagination_callback(callback: CallbackQuery):
    if is_admin(callback.from_user.id):
        page = int(callback.data.split("_")[2])
        await show_audit_log_page(callback, page)
    await callback.answer()

@dp.callback_query(F.data == "admin_add_product")
async def start_adding_product_callback(callback: CallbackQuery, state: FSMContext):
    if is_staff(callback.from_user.id):
        await state.set_state(AdminState.adding_product_name)
        await callback.message.edit_text("‚ûï –î–û–ë–ê–í–õ–ï–ù–ò–ï –¢–û–í–ê–†–ê\n\nüìù –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:")
        log_audit(callback.from_user.id, callback.from_user.username, "start_add_product", "–ù–∞—á–∞—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞")
    await callback.answer()

@dp.message(AdminState.adding_product_name)
async def handle_product_name_message(message: Message, state: FSMContext):
    await state.update_data(product_name=message.text)
    await state.set_state(AdminState.adding_product_price)
    await message.answer("üí∞ –í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞ (–≤ —Ä—É–±–ª—è—Ö):")
    log_audit(message.from_user.id, message.from_user.username, "add_product_name", f"–ù–∞–∑–≤–∞–Ω–∏–µ: {message.text}")

@dp.message(AdminState.adding_product_price)
async def handle_product_price_message(message: Message, state: FSMContext):
    try:
        price = float(message.text)
        if price <= 0:
            raise ValueError("–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π")
        
        await state.update_data(product_price=price)
        await state.set_state(AdminState.adding_product_quantity)
        await message.answer("üì¶ –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞:")
        log_audit(message.from_user.id, message.from_user.username, "add_product_price", f"–¶–µ–Ω–∞: {price} —Ä—É–±.")
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É (—á–∏—Å–ª–æ):")

@dp.message(AdminState.adding_product_quantity)
async def handle_product_quantity_message(message: Message, state: FSMContext):
    try:
        quantity = int(message.text)
        if quantity < 0:
            raise ValueError("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º")
        
        await state.update_data(product_quantity=quantity)
        await state.set_state(AdminState.adding_product_category)
        await message.answer("üìÇ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞:", reply_markup=get_category_keyboard())
        log_audit(message.from_user.id, message.from_user.username, "add_product_quantity", f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {quantity}")
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞:")

@dp.callback_query(F.data.startswith("select_category_"))
async def handle_product_category_callback(callback: CallbackQuery, state: FSMContext):
    if is_staff(callback.from_user.id):
        category = callback.data.split("_")[2]
        await state.update_data(product_category=category)
        await state.set_state(AdminState.adding_product_unit)
        await callback.message.edit_text("üìè –í–≤–µ–¥–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è (—à—Ç., –º¬≥, –∫–≥, –º–µ—à–æ–∫ –∏ —Ç.–¥.):")
        log_audit(callback.from_user.id, callback.from_user.username, "add_product_category", f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}")
    await callback.answer()

@dp.callback_query(F.data == "new_category")
async def handle_new_category_callback(callback: CallbackQuery, state: FSMContext):
    if is_staff(callback.from_user.id):
        await callback.message.edit_text("üìÇ –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:")
        # –°–æ—Ö—Ä–∞–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –µ–¥–∏–Ω–∏—Ü–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è
        await state.set_state(AdminState.adding_product_category)
    await callback.answer()

@dp.message(AdminState.adding_product_category)
async def handle_new_category_input_message(message: Message, state: FSMContext):
    await state.update_data(product_category=message.text.strip().lower())
    await state.set_state(AdminState.adding_product_unit)
    await message.answer("üìè –í–≤–µ–¥–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è (—à—Ç., –º¬≥, –∫–≥, –º–µ—à–æ–∫ –∏ —Ç.–¥.):")
    log_audit(message.from_user.id, message.from_user.username, "add_new_category", f"–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: {message.text}")

@dp.message(AdminState.adding_product_unit)
async def handle_product_unit_message(message: Message, state: FSMContext):
    await state.update_data(product_unit=message.text)
    await state.set_state(AdminState.adding_product_description)
    await message.answer("üìù –í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ '-' –µ—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ):")
    log_audit(message.from_user.id, message.from_user.username, "add_product_unit", f"–ï–¥–∏–Ω–∏—Ü–∞: {message.text}")

@dp.message(AdminState.adding_product_description)
async def handle_product_description_message(message: Message, state: FSMContext):
    user_data = await state.get_data()
    description = message.text if message.text != "-" else ""
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–≤–∞—Ä
    add_product(
        user_data['product_name'],
        user_data['product_price'],
        user_data['product_quantity'],
        user_data['product_category'],
        user_data['product_unit'],
        description
    )
    
    await message.answer("‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!", reply_markup=get_products_panel_keyboard())
    log_audit(message.from_user.id, message.from_user.username, "add_product_complete", 
             f"–¢–æ–≤–∞—Ä: {user_data['product_name']}, –¶–µ–Ω–∞: {user_data['product_price']}, –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {user_data['product_category']}")
    
    await state.clear()

@dp.callback_query(F.data == "cancel_add_product")
async def cancel_add_product_callback(callback: CallbackQuery, state: FSMContext):
    if is_staff(callback.from_user.id):
        await state.clear()
        await callback.message.edit_text("‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ", reply_markup=get_products_panel_keyboard())
        log_audit(callback.from_user.id, callback.from_user.username, "cancel_add_product", "–û—Ç–º–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞")
    await callback.answer()

@dp.callback_query(F.data == "admin_edit_product")
async def start_editing_product_callback(callback: CallbackQuery):
    if is_staff(callback.from_user.id):
        await callback.message.edit_text("‚úèÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", reply_markup=get_admin_products_keyboard())
    await callback.answer()

@dp.callback_query(F.data.startswith("admin_product_"))
async def handle_delete_product_selection_callback(callback: CallbackQuery, state: FSMContext):
    if is_staff(callback.from_user.id):
        product_id = int(callback.data.split("_")[2])
        product = get_product_by_id(product_id)
        
        if product:
            await state.update_data(deleting_product_id=product_id)
            
            confirm_text = f"""
üóëÔ∏è <b>–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –£–î–ê–õ–ï–ù–ò–Ø</b>

–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä:
"{product[1]}"

üí∞ –¶–µ–Ω–∞: {product[2]} —Ä—É–±.
üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {product[3]} {product[5]}
üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {product[4]}
"""

            # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –î–∞/–ù–µ—Ç
            confirm_keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"confirm_delete_{product_id}")],
                [InlineKeyboardButton(text="‚ùå –ù–µ—Ç, –æ—Å—Ç–∞–≤–∏—Ç—å", callback_data="cancel_delete")]
            ])
            
            await callback.message.edit_text(confirm_text, parse_mode="HTML", reply_markup=confirm_keyboard)
            log_audit(callback.from_user.id, callback.from_user.username, "confirm_delete", f"–¢–æ–≤–∞—Ä ID: {product_id}")
    await callback.answer()

@dp.callback_query(F.data.startswith("confirm_delete_"))
async def handle_confirm_delete_callback(callback: CallbackQuery):
    if is_staff(callback.from_user.id):
        product_id = int(callback.data.split("_")[2])
        product = get_product_by_id(product_id)
        
        if product:
            delete_product(product_id)
            await callback.message.edit_text(
                f"‚úÖ –¢–æ–≤–∞—Ä '{product[1]}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!", 
                reply_markup=get_products_panel_keyboard()
            )
            log_audit(callback.from_user.id, callback.from_user.username, "delete_product", 
                     f"–¢–æ–≤–∞—Ä ID: {product_id}, –ù–∞–∑–≤–∞–Ω–∏–µ: {product[1]}")
    await callback.answer()

@dp.callback_query(F.data == "cancel_delete")
async def handle_cancel_delete_callback(callback: CallbackQuery):
    if is_staff(callback.from_user.id):
        await callback.message.edit_text(
            "‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ", 
            reply_markup=get_products_panel_keyboard()
        )
        log_audit(callback.from_user.id, callback.from_user.username, "cancel_delete", "–û—Ç–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞")
    await callback.answer()


@dp.callback_query(F.data.startswith("admin_product_"))
async def handle_product_selection_callback(callback: CallbackQuery):
    if is_staff(callback.from_user.id):
        product_id = int(callback.data.split("_")[2])
        product = get_product_by_id(product_id)
        
        if product:
            product_info = f"""
‚úèÔ∏è <b>–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –¢–û–í–ê–†–ê</b>

üîπ –ù–∞–∑–≤–∞–Ω–∏–µ: {product[1]}
üí∞ –¶–µ–Ω–∞: {product[2]} —Ä—É–±.
üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {product[3]} {product[5]}
üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {product[4]}
üìè –ï–¥–∏–Ω–∏—Ü–∞: {product[5]}
üìù –û–ø–∏—Å–∞–Ω–∏–µ: {product[6] or '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}

–í—ã–±–µ—Ä–∏—Ç–µ —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ <b>–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</b>:
"""
            await callback.message.edit_text(product_info, parse_mode="HTML", reply_markup=get_edit_product_keyboard(product_id))
    await callback.answer()

@dp.callback_query(F.data.startswith("edit_name_"))
async def start_editing_name_callback(callback: CallbackQuery, state: FSMContext):
    if is_staff(callback.from_user.id):
        product_id = int(callback.data.split("_")[2])
        product = get_product_by_id(product_id)
        
        if product:
            await state.update_data(editing_product_id=product_id)
            await state.set_state(AdminState.editing_product_name)
            await callback.message.edit_text(f"‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ '{product[1]}':")
            log_audit(callback.from_user.id, callback.from_user.username, "start_edit_name", f"–¢–æ–≤–∞—Ä ID: {product_id}")
    await callback.answer()

@dp.message(AdminState.editing_product_name)
async def handle_edit_name_message(message: Message, state: FSMContext):
    user_data = await state.get_data()
    product_id = user_data.get('editing_product_id')
    
    try:
        new_name = message.text.strip()
        if not new_name:
            raise ValueError("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        
        product = get_product_by_id(product_id)
        if product:
            update_product_name(product_id, new_name)
            await message.answer(f"‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ '{new_name}'!", reply_markup=get_products_panel_keyboard())
            log_audit(message.from_user.id, message.from_user.username, "edit_name", 
                     f"–¢–æ–≤–∞—Ä ID: {product_id}, –ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: {new_name}")
        
    except Exception as e:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è.")
    
    await state.clear()

@dp.callback_query(F.data.startswith("edit_price_"))
async def start_editing_price_callback(callback: CallbackQuery, state: FSMContext):
    if is_staff(callback.from_user.id):
        product_id = int(callback.data.split("_")[2])
        product = get_product_by_id(product_id)
        
        if product:
            await state.update_data(editing_product_id=product_id)
            await state.set_state(AdminState.editing_product_price)
            await callback.message.edit_text(f"üí∞ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É –¥–ª—è —Ç–æ–≤–∞—Ä–∞ '{product[1]}' (—Ç–µ–∫—É—â–∞—è: {product[2]} —Ä—É–±.):")
            log_audit(callback.from_user.id, callback.from_user.username, "start_edit_price", f"–¢–æ–≤–∞—Ä ID: {product_id}")
    await callback.answer()

@dp.message(AdminState.editing_product_price)
async def handle_edit_price_message(message: Message, state: FSMContext):
    user_data = await state.get_data()
    product_id = user_data.get('editing_product_id')
    
    try:
        new_price = float(message.text.strip())
        if new_price <= 0:
            raise ValueError("–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π")
        
        product = get_product_by_id(product_id)
        if product:
            update_product_price(product_id, new_price)
            await message.answer(f"‚úÖ –¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ {new_price} —Ä—É–±.!", reply_markup=get_products_panel_keyboard())
            log_audit(message.from_user.id, message.from_user.username, "edit_price", 
                     f"–¢–æ–≤–∞—Ä ID: {product_id}, –ù–æ–≤–∞—è —Ü–µ–Ω–∞: {new_price} —Ä—É–±.")
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è —Ü–µ–Ω—ã.")
    except Exception as e:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω—ã.")
    
    await state.clear()

@dp.callback_query(F.data.startswith("edit_quantity_"))
async def start_editing_quantity_callback(callback: CallbackQuery, state: FSMContext):
    if is_staff(callback.from_user.id):
        product_id = int(callback.data.split("_")[2])
        product = get_product_by_id(product_id)
        
        if product:
            await state.update_data(editing_product_id=product_id)
            await state.set_state(AdminState.editing_product_quantity)
            await callback.message.edit_text(f"üì¶ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ '{product[1]}' (—Ç–µ–∫—É—â–µ–µ: {product[3]} {product[5]}):")
            log_audit(callback.from_user.id, callback.from_user.username, "start_edit_quantity", f"–¢–æ–≤–∞—Ä ID: {product_id}")
    await callback.answer()

@dp.message(AdminState.editing_product_quantity)
async def handle_edit_quantity_message(message: Message, state: FSMContext):
    user_data = await state.get_data()
    product_id = user_data.get('editing_product_id')
    
    try:
        new_quantity = int(message.text.strip())
        if new_quantity < 0:
            raise ValueError("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º")
        
        product = get_product_by_id(product_id)
        if product:
            update_product_quantity(product_id, new_quantity)
            await message.answer(f"‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ {new_quantity} {product[5]}!", reply_markup=get_products_panel_keyboard())
            log_audit(message.from_user.id, message.from_user.username, "edit_quantity", 
                     f"–¢–æ–≤–∞—Ä ID: {product_id}, –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {new_quantity}")
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.")
    except Exception as e:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.")
    
    await state.clear()

@dp.callback_query(F.data.startswith("edit_category_"))
async def start_editing_category_callback(callback: CallbackQuery, state: FSMContext):
    if is_staff(callback.from_user.id):
        product_id = int(callback.data.split("_")[2])
        product = get_product_by_id(product_id)
        
        if product:
            await state.update_data(editing_product_id=product_id)
            await state.set_state(AdminState.editing_product_category)
            categories = get_product_categories()
            categories_text = "\n".join([f"‚Ä¢ {cat}" for cat in categories])
            await callback.message.edit_text(
                f"üìÇ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —Ç–æ–≤–∞—Ä–∞ '{product[1]}' (—Ç–µ–∫—É—â–∞—è: {product[4]})\n\n"
                f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:\n{categories_text}\n\n"
                f"–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:"
            )
            log_audit(callback.from_user.id, callback.from_user.username, "start_edit_category", f"–¢–æ–≤–∞—Ä ID: {product_id}")
    await callback.answer()

@dp.message(AdminState.editing_product_category)
async def handle_edit_category_message(message: Message, state: FSMContext):
    user_data = await state.get_data()
    product_id = user_data.get('editing_product_id')
    
    try:
        new_category = message.text.strip().lower()
        if not new_category:
            raise ValueError("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π")
        
        product = get_product_by_id(product_id)
        if product:
            update_product_category(product_id, new_category)
            await message.answer(f"‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ '{new_category}'!", reply_markup=get_products_panel_keyboard())
            log_audit(message.from_user.id, message.from_user.username, "edit_category", 
                     f"–¢–æ–≤–∞—Ä ID: {product_id}, –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: {new_category}")
        
    except Exception as e:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.")
    
    await state.clear()

@dp.callback_query(F.data.startswith("edit_unit_"))
async def start_editing_unit_callback(callback: CallbackQuery, state: FSMContext):
    if is_staff(callback.from_user.id):
        product_id = int(callback.data.split("_")[2])
        product = get_product_by_id(product_id)
        
        if product:
            await state.update_data(editing_product_id=product_id)
            await state.set_state(AdminState.editing_product_unit)
            await callback.message.edit_text(f"üìè –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–ª—è —Ç–æ–≤–∞—Ä–∞ '{product[1]}' (—Ç–µ–∫—É—â–∞—è: {product[5]}):")
            

@dp.message(AdminState.editing_product_unit)
async def handle_edit_unit_message(message: Message, state: FSMContext):
    user_data = await state.get_data()
    product_id = user_data.get('editing_product_id')
    
    try:
        new_unit = message.text.strip()
        if not new_unit:
            raise ValueError("–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π")
        
        product = get_product_by_id(product_id)
        if product:
            update_product_unit(product_id, new_unit)
            await message.answer(f"‚úÖ –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ '{new_unit}'!", reply_markup=get_products_panel_keyboard())
            log_audit(message.from_user.id, message.from_user.username, "edit_unit", 
                     f"–¢–æ–≤–∞—Ä ID: {product_id}, –ù–æ–≤–∞—è –µ–¥–∏–Ω–∏—Ü–∞: {new_unit}")
        
    except Exception as e:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è.")
    
    await state.clear()

@dp.callback_query(F.data.startswith("edit_description_"))
async def start_editing_description_callback(callback: CallbackQuery, state: FSMContext):
    if is_staff(callback.from_user.id):
        product_id = int(callback.data.split("_")[2])
        product = get_product_by_id(product_id)
        
        if product:
            await state.update_data(editing_product_id=product_id)
            await state.set_state(AdminState.editing_product_description)
            current_desc = product[6] or "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
            await callback.message.edit_text(f"üìù –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ '{product[1]}' (—Ç–µ–∫—É—â–µ–µ: {current_desc}):")
            log_audit(callback.from_user.id, callback.from_user.username, "start_edit_description", f"–¢–æ–≤–∞—Ä ID: {product_id}")
    await callback.answer()

@dp.message(AdminState.editing_product_description)
async def handle_edit_description_message(message: Message, state: FSMContext):
    user_data = await state.get_data()
    product_id = user_data.get('editing_product_id')
    
    try:
        new_description = message.text.strip()
        product = get_product_by_id(product_id)
        if product:
            update_product_description(product_id, new_description)
            await message.answer("‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!", reply_markup=get_products_panel_keyboard())
            log_audit(message.from_user.id, message.from_user.username, "edit_description", 
                     f"–¢–æ–≤–∞—Ä ID: {product_id}, –ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: {new_description[:50]}...")
        
    except Exception as e:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è.")
    
    await state.clear()

@dp.callback_query(F.data == "admin_delete_product")
async def start_deleting_product_callback(callback: CallbackQuery):
    if is_staff(callback.from_user.id):
        await callback.message.edit_text("üóëÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=get_admin_products_keyboard())
    await callback.answer()


@dp.callback_query(F.data.startswith("products_page_"))
async def handle_products_pagination_callback(callback: CallbackQuery):
    if is_staff(callback.from_user.id):
        page = int(callback.data.split("_")[2])
        await callback.message.edit_text("‚úèÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", reply_markup=get_admin_products_keyboard(page))
    await callback.answer()

@dp.callback_query(F.data == "admin_edit_product_1")
async def handle_back_to_products_list_callback(callback: CallbackQuery):
    if is_staff(callback.from_user.id):
        await callback.message.edit_text("‚úèÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", reply_markup=get_admin_products_keyboard(1))
        log_audit(callback.from_user.id, callback.from_user.username, "back_to_products_list", "–í–æ–∑–≤—Ä–∞—Ç –∫ —Å–ø–∏—Å–∫—É —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞")
    await callback.answer()

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    init_db()  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
